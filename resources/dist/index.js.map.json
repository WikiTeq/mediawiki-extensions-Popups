{"version":3,"file":"index.js","mappings":"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","sources":["/w/extensions/Popups/./src/canSaveToUserPreferences.js","/w/extensions/Popups/./node_modules/redux-thunk/dist/redux-thunk.min.js","/w/extensions/Popups/./node_modules/redux/dist/redux.min.js","/w/extensions/Popups/./src/ui/pointer-mask.svg","/w/extensions/Popups/webpack/bootstrap","/w/extensions/Popups/webpack/runtime/compat get default export","/w/extensions/Popups/webpack/runtime/define property getters","/w/extensions/Popups/webpack/runtime/global","/w/extensions/Popups/webpack/runtime/hasOwnProperty shorthand","/w/extensions/Popups/webpack/runtime/make namespace object","/w/extensions/Popups/webpack/runtime/node module decorator","/w/extensions/Popups/./src/constants.js","/w/extensions/Popups/./src/bracketedPixelRatio.js","/w/extensions/Popups/./src/wait.js","/w/extensions/Popups/./src/ui/thumbnail.js","/w/extensions/Popups/./src/ui/templates/templateUtil.js","/w/extensions/Popups/./src/ui/templates/popup/popup.js","/w/extensions/Popups/./src/ui/templates/preview/preview.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/arrayLikeToArray.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/unsupportedIterableToArray.js","/w/extensions/Popups/./src/ui/templates/pagePreview/pagePreview.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/toConsumableArray.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/arrayWithoutHoles.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/iterableToArray.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/nonIterableSpread.js","/w/extensions/Popups/./src/ui/renderer.js","/w/extensions/Popups/./src/preview/model.js","/w/extensions/Popups/./src/formatter.js","/w/extensions/Popups/./src/gateway/index.js","/w/extensions/Popups/./src/gateway/mediawiki.js","/w/extensions/Popups/./src/gateway/rest.js","/w/extensions/Popups/./src/gateway/restFormatters.js","/w/extensions/Popups/./src/gateway/page.js","/w/extensions/Popups/./src/userSettings.js","/w/extensions/Popups/./src/previewBehavior.js","/w/extensions/Popups/./src/ui/settingsDialogRenderer.js","/w/extensions/Popups/./src/ui/settingsDialog.js","/w/extensions/Popups/./src/ui/templates/settingsDialog/settingsDialog.js","/w/extensions/Popups/./src/changeListener.js","/w/extensions/Popups/./src/isPagePreviewsEnabled.js","/w/extensions/Popups/./src/changeListeners/syncUserSettings.js","/w/extensions/Popups/./src/changeListeners/index.js","/w/extensions/Popups/./src/changeListeners/footerLink.js","/w/extensions/Popups/./src/changeListeners/linkTitle.js","/w/extensions/Popups/./src/changeListeners/pageviews.js","/w/extensions/Popups/./src/changeListeners/render.js","/w/extensions/Popups/./src/changeListeners/settings.js","/w/extensions/Popups/./src/changeListeners/statsv.js","/w/extensions/Popups/./src/actionTypes.js","/w/extensions/Popups/./src/actions.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/slicedToArray.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/arrayWithHoles.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/iterableToArrayLimit.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/nonIterableRest.js","/w/extensions/Popups/./src/reducers/nextState.js","/w/extensions/Popups/./node_modules/@babel/runtime/helpers/esm/defineProperty.js","/w/extensions/Popups/./src/reducers/index.js","/w/extensions/Popups/./src/reducers/pageviews.js","/w/extensions/Popups/./src/reducers/preview.js","/w/extensions/Popups/./src/reducers/settings.js","/w/extensions/Popups/./src/reducers/statsv.js","/w/extensions/Popups/./src/index.js","/w/extensions/Popups/./src/title.js","/w/extensions/Popups/./src/setUserConfigFlags.js","/w/extensions/Popups/./src/experiments.js","/w/extensions/Popups/./src/gateway/restWithSearch.js","/w/extensions/Popups/./src/instrumentation/statsv.js","/w/extensions/Popups/./src/integrations/mwpopups.js"],"sourcesContent":["/**\r\n * @module canSaveToUserPreferences\r\n * @private\r\n */\r\n\r\n/**\r\n * Can the current user save to user preferences?\r\n *\r\n * @param {User} user\r\n * @return {boolean}\r\n */\r\nconst canSaveToUserPreferences = ( user ) => {\r\n\treturn !user.isAnon() && user.isNamed();\r\n};\r\n\r\nmodule.exports = canSaveToUserPreferences;\r\n","!function(t,e){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=e():\"function\"==typeof define&&define.amd?define([],e):\"object\"==typeof exports?exports.ReduxThunk=e():t.ReduxThunk=e()}(this,function(){return function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={exports:{},id:o,loaded:!1};return t[o].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p=\"\",e(0)}([function(t,e,n){t.exports=n(1)},function(t,e){\"use strict\";function n(t){return function(e){var n=e.dispatch,o=e.getState;return function(e){return function(r){return\"function\"==typeof r?r(n,o,t):e(r)}}}}e.__esModule=!0;var o=n();o.withExtraArgument=n,e.default=o}])});","!function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?t(exports):\"function\"==typeof define&&define.amd?define([\"exports\"],t):t(e.Redux={})}(this,function(e){\"use strict\";var t=function(e){var t,r=e.Symbol;return\"function\"==typeof r?r.observable?t=r.observable:(t=r(\"observable\"),r.observable=t):t=\"@@observable\",t}(\"undefined\"!=typeof self?self:\"undefined\"!=typeof window?window:\"undefined\"!=typeof global?global:\"undefined\"!=typeof module?module:Function(\"return this\")()),r=function(){return Math.random().toString(36).substring(7).split(\"\").join(\".\")},n={INIT:\"@@redux/INIT\"+r(),REPLACE:\"@@redux/REPLACE\"+r(),PROBE_UNKNOWN_ACTION:function(){return\"@@redux/PROBE_UNKNOWN_ACTION\"+r()}};function o(e,t){var r=t&&t.type;return\"Given \"+(r&&'action \"'+r+'\"'||\"an action\")+', reducer \"'+e+'\" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function i(e,t){return function(){return t(e.apply(this,arguments))}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})}e.createStore=function e(r,o,i){var u;if(\"function\"==typeof o&&\"function\"==typeof i||\"function\"==typeof i&&\"function\"==typeof arguments[3])throw Error(\"It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function\");if(\"function\"==typeof o&&void 0===i&&(i=o,o=void 0),void 0!==i){if(\"function\"!=typeof i)throw Error(\"Expected the enhancer to be a function.\");return i(e)(r,o)}if(\"function\"!=typeof r)throw Error(\"Expected the reducer to be a function.\");var a=r,c=o,f=[],s=f,d=!1;function l(){s===f&&(s=f.slice())}function p(){if(d)throw Error(\"You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.\");return c}function h(e){if(\"function\"!=typeof e)throw Error(\"Expected the listener to be a function.\");if(d)throw Error(\"You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.\");var t=!0;return l(),s.push(e),function(){if(t){if(d)throw Error(\"You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.\");t=!1,l();var r=s.indexOf(e);s.splice(r,1)}}}function y(e){if(!function(e){if(\"object\"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}(e))throw Error(\"Actions must be plain objects. Use custom middleware for async actions.\");if(void 0===e.type)throw Error('Actions may not have an undefined \"type\" property. Have you misspelled a constant?');if(d)throw Error(\"Reducers may not dispatch actions.\");try{d=!0,c=a(c,e)}finally{d=!1}for(var t=f=s,r=0;t.length>r;r++)(0,t[r])();return e}return y({type:n.INIT}),(u={dispatch:y,subscribe:h,getState:p,replaceReducer:function(e){if(\"function\"!=typeof e)throw Error(\"Expected the nextReducer to be a function.\");a=e,y({type:n.REPLACE})}})[t]=function(){var e,r=h;return(e={subscribe:function(e){if(\"object\"!=typeof e||null===e)throw new TypeError(\"Expected the observer to be an object.\");function t(){e.next&&e.next(p())}return t(),{unsubscribe:r(t)}}})[t]=function(){return this},e},u},e.combineReducers=function(e){for(var t=Object.keys(e),r={},i=0;t.length>i;i++){var u=t[i];\"function\"==typeof e[u]&&(r[u]=e[u])}var a,c=Object.keys(r);try{!function(e){Object.keys(e).forEach(function(t){var r=e[t];if(void 0===r(void 0,{type:n.INIT}))throw Error('Reducer \"'+t+\"\\\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.\");if(void 0===r(void 0,{type:n.PROBE_UNKNOWN_ACTION()}))throw Error('Reducer \"'+t+\"\\\" returned undefined when probed with a random type. Don't try to handle \"+n.INIT+' or other actions in \"redux/*\" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')})}(r)}catch(e){a=e}return function(e,t){if(void 0===e&&(e={}),a)throw a;for(var n=!1,i={},u=0;c.length>u;u++){var f=c[u],s=e[f],d=(0,r[f])(s,t);if(void 0===d){var l=o(f,t);throw Error(l)}i[f]=d,n=n||d!==s}return n?i:e}},e.bindActionCreators=function(e,t){if(\"function\"==typeof e)return i(e,t);if(\"object\"!=typeof e||null===e)throw Error(\"bindActionCreators expected an object or a function, instead received \"+(null===e?\"null\":typeof e)+'. Did you write \"import ActionCreators from\" instead of \"import * as ActionCreators from\"?');for(var r=Object.keys(e),n={},o=0;r.length>o;o++){var u=r[o],a=e[u];\"function\"==typeof a&&(n[u]=i(a,t))}return n},e.applyMiddleware=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return function(e){return function(){var r=e.apply(void 0,arguments),n=function(){throw Error(\"Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.\")},o={getState:r.getState,dispatch:function(){return n.apply(void 0,arguments)}},i=t.map(function(e){return e(o)});return function(e){for(var t=1;arguments.length>t;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);\"function\"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){u(e,t,r[t])})}return e}({},r,{dispatch:n=a.apply(void 0,i)(r.dispatch)})}}},e.compose=a,e.__DO_NOT_USE__ActionTypes=n,Object.defineProperty(e,\"__esModule\",{value:!0})});\n","module.exports = \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"0\\\" height=\\\"0\\\"><defs><clipPath id=\\\"mwe-popups-mask\\\"><path d=\\\"M0 8h10l8-8 8 8h974v992H0z\\\"></path></clipPath><clipPath id=\\\"mwe-popups-mask-flip\\\"><path d=\\\"M0 8h294l8-8 8 8h690v992H0z\\\"></path></clipPath><clipPath id=\\\"mwe-popups-landscape-mask\\\"><path d=\\\"M0 8h174l8-8 8 8h810v992H0z\\\"></path></clipPath><clipPath id=\\\"mwe-popups-landscape-mask-flip\\\"><path d=\\\"M0 0h1000v242H190l-8 8-8-8H0z\\\"></path></clipPath></defs></svg>\"","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\tid: moduleId,\n\t\tloaded: false,\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Flag the module as loaded\n\tmodule.loaded = true;\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.nmd = (module) => {\n\tmodule.paths = [];\n\tif (!module.children) module.children = [];\n\treturn module;\n};","import bracketedPixelRatio from './bracketedPixelRatio';\r\n\r\nconst bpr = bracketedPixelRatio();\r\n\r\n// See the following for context around this value.\r\n//\r\n// * https://phabricator.wikimedia.org/T161284\r\n// * https://phabricator.wikimedia.org/T70861#3129780\r\nexport const FETCH_START_DELAY = 150; // ms.\r\n// The delay after which a FETCH_COMPLETE action should be dispatched.\r\n//\r\n// If the API endpoint responds faster than 350 ms (or, say, the API\r\n// response is served from the UA's cache), then we introduce a delay of\r\n// 350 ms - t to make the preview delay consistent to the user. The total\r\n// delay from start to finish is 500 ms.\r\nexport const FETCH_COMPLETE_TARGET_DELAY = 350 + FETCH_START_DELAY; // ms.\r\n// The minimum time a preview must be open before we judge it\r\n// has been seen.\r\n// See https://phabricator.wikimedia.org/T184793\r\nexport const PREVIEW_SEEN_DURATION = 1000; // ms\r\nexport const ABANDON_END_DELAY = 300;\r\n\r\nexport default {\r\n\tBRACKETED_DEVICE_PIXEL_RATIO: bpr,\r\n\t// See https://phabricator.wikimedia.org/T272169: requesting a larger thumbnail to avoid bluriness\r\n\tTHUMBNAIL_SIZE: 320 * Math.max( bpr, 1.5 ),\r\n\tEXTRACT_LENGTH: 525\r\n};\r\n","/**\r\n * @module bracketedPixelRatio\r\n * @private\r\n */\r\n\r\n/**\r\n * Normalizes a user's device pixel ratio to either 1, 1.5, or 2.\r\n *\r\n * This is important when the server resizes images on the fly in order to\r\n * reduce the work it has to do for device pixel ratios that deviate from a\r\n * set of common ratios.\r\n *\r\n * Adapted from mediawiki/core /resources/src/jquery/jquery.hidpi.js\r\n *\r\n * @param {number} [dpr=window.devicePixelRatio]\r\n * @return {number} The bracketed device pixel ratio\r\n */\r\nexport default function ( dpr = window.devicePixelRatio ) {\r\n\tif ( !dpr ) {\r\n\t\t// Probably legacy browser so assume 1\r\n\t\treturn 1;\r\n\t}\r\n\r\n\tif ( dpr > 1.5 ) {\r\n\t\treturn 2;\r\n\t}\r\n\r\n\tif ( dpr > 1 ) {\r\n\t\treturn 1.5;\r\n\t}\r\n\r\n\treturn 1;\r\n}\r\n","/**\r\n * @module wait\r\n * @private\r\n */\r\n\r\n/**\r\n * Sugar around `window.setTimeout`.\r\n *\r\n * @example\r\n * import wait from './wait';\r\n *\r\n * wait( 150 )\r\n *   .then( () => {\r\n *     // Continue processing...\r\n *   } );\r\n *\r\n * @param {number} delay The number of milliseconds to wait\r\n * @return {Promise}\r\n */\r\nexport default function wait( delay ) {\r\n\treturn new Promise( ( resolve ) => {\r\n\t\tsetTimeout( () => {\r\n\t\t\tresolve();\r\n\t\t}, delay );\r\n\t} );\r\n}\r\n","/**\r\n * @module thumbnail\r\n * @private\r\n */\r\n\r\nimport constants from '../constants';\r\n\r\nexport const SIZES = {\r\n\tportraitImage: {\r\n\t\th: 250, // Exact height\r\n\t\tw: 203 // Max width\r\n\t},\r\n\tlandscapeImage: {\r\n\t\th: 200, // Max height\r\n\t\tw: 320 // Exact Width\r\n\t}\r\n};\r\n\r\n/**\r\n * @typedef {Object} ext.popups.Thumbnail\r\n * @property {jQuery} el\r\n * @property {boolean} isTall Whether or not the thumbnail is portrait\r\n * @property {number} width\r\n * @property {number} height\r\n * @property {boolean} isNarrow whether the thumbnail is portrait and also\r\n *  thinner than the default portrait thumbnail width\r\n *  (as defined in SIZES.portraitImage.w)\r\n * @property {number} offset in pixels between the thumbnail width and the\r\n *  standard portrait thumbnail width (as defined in SIZES.portraitImage.w)\r\n */\r\n\r\n/**\r\n * Creates a thumbnail from the representation of a thumbnail returned by the\r\n * PageImages MediaWiki API query module.\r\n *\r\n * If there's no thumbnail, the thumbnail is too small, or the thumbnail's URL\r\n * contains characters that could be used to perform an\r\n * [XSS attack via CSS](https://www.owasp.org/index.php/Testing_for_CSS_Injection_(OTG-CLIENT-005)),\r\n * then `null` is returned.\r\n *\r\n * Extracted from `mw.popups.renderer.article.createThumbnail`.\r\n *\r\n * @param {Object} rawThumbnail\r\n * @param {boolean} useCSSClipPath\r\n * @return {ext.popups.Thumbnail|null}\r\n */\r\nexport function createThumbnail( rawThumbnail, useCSSClipPath ) {\r\n\tconst devicePixelRatio = constants.BRACKETED_DEVICE_PIXEL_RATIO;\r\n\r\n\tif ( !rawThumbnail ) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst thumbWidth = rawThumbnail.width / devicePixelRatio;\r\n\tconst thumbHeight = rawThumbnail.height / devicePixelRatio;\r\n\t// For images less than 320 wide, try to display a 250 high vertical slice instead\r\n\tconst tall = rawThumbnail.height > rawThumbnail.width || thumbWidth < SIZES.landscapeImage.w;\r\n\r\n\tif (\r\n\t\t// Image too small for portrait display\r\n\t\t( tall && thumbHeight < SIZES.portraitImage.h &&\r\n\t\t\trawThumbnail.height < SIZES.portraitImage.h ) ||\r\n\t\t// These characters in URL that could inject CSS and thus JS\r\n\t\t(\r\n\t\t\trawThumbnail.source.indexOf( '\\\\' ) > -1 ||\r\n\t\t\trawThumbnail.source.indexOf( '\\'' ) > -1 ||\r\n\t\t\trawThumbnail.source.indexOf( '\"' ) > -1\r\n\t\t)\r\n\t) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst aspectRatio = thumbWidth / thumbHeight;\r\n\tconst isSquare = aspectRatio > 0.7 && aspectRatio < 1.3;\r\n\r\n\tlet x, y, width, height;\r\n\tif ( tall ) {\r\n\t\tx = ( thumbWidth > SIZES.portraitImage.w ) ?\r\n\t\t\t( ( thumbWidth - SIZES.portraitImage.w ) / -2 ) :\r\n\t\t\t( SIZES.portraitImage.w - thumbWidth );\r\n\t\ty = ( thumbHeight > SIZES.portraitImage.h ) ?\r\n\t\t\t( ( thumbHeight - SIZES.portraitImage.h ) / -2 ) : 0;\r\n\t\twidth = SIZES.portraitImage.w;\r\n\t\theight = SIZES.portraitImage.h;\r\n\r\n\t\t// Special handling for thin tall images\r\n\t\t// https://phabricator.wikimedia.org/T192928#4312088\r\n\t\tif ( thumbWidth < width ) {\r\n\t\t\tx = 0;\r\n\t\t\twidth = thumbWidth;\r\n\t\t}\r\n\t} else {\r\n\t\tx = 0;\r\n\t\ty = ( thumbHeight > SIZES.landscapeImage.h ) ?\r\n\t\t\t( ( thumbHeight - SIZES.landscapeImage.h ) / -2 ) : 0;\r\n\t\twidth = SIZES.landscapeImage.w;\r\n\t\theight = ( thumbHeight > SIZES.landscapeImage.h ) ?\r\n\t\t\tSIZES.landscapeImage.h : thumbHeight;\r\n\t}\r\n\r\n\tconst isNarrow = tall && thumbWidth < SIZES.portraitImage.w;\r\n\tconst el = useCSSClipPath ? createThumbnailImg( rawThumbnail.source ) : createThumbnailSVG(\r\n\t\ttall ? 'mwe-popups-is-tall' : 'mwe-popups-is-not-tall',\r\n\t\trawThumbnail.source,\r\n\t\tx,\r\n\t\ty,\r\n\t\tthumbWidth,\r\n\t\tthumbHeight,\r\n\t\twidth,\r\n\t\theight\r\n\t);\r\n\r\n\treturn {\r\n\t\tel,\r\n\t\tisTall: tall || isSquare,\r\n\t\tisNarrow,\r\n\t\toffset: isNarrow ? SIZES.portraitImage.w - thumbWidth : 0,\r\n\t\twidth: thumbWidth,\r\n\t\theight: thumbHeight\r\n\t};\r\n}\r\n\r\nfunction createThumbnailImg( url ) {\r\n\tconst img = document.createElement( 'img' );\r\n\timg.className = 'mwe-popups-thumbnail';\r\n\timg.src = url;\r\n\treturn img;\r\n}\r\n\r\n/**\r\n * Sets multiple attributes on a node.\r\n *\r\n * @param {HTMLElement} node\r\n * @param {Record<string, string>} attrs\r\n */\r\nconst addAttributes = ( node, attrs ) => {\r\n\tObject.keys( attrs ).forEach( ( key ) => {\r\n\t\tnode.setAttribute( key, attrs[ key ] );\r\n\t} );\r\n};\r\n\r\n/**\r\n * Creates the SVG image element that represents the thumbnail.\r\n *\r\n * This function is distinct from `createThumbnail` as it abstracts away some\r\n * browser issues that are uncovered when manipulating elements across\r\n * namespaces.\r\n *\r\n * @param {string} className\r\n * @param {string} url\r\n * @param {number} x\r\n * @param {number} y\r\n * @param {number} thumbnailWidth\r\n * @param {number} thumbnailHeight\r\n * @param {number} width\r\n * @param {number} height\r\n * @return {HTMLElement}\r\n */\r\n\r\nexport function createThumbnailSVG(\r\n\tclassName, url, x, y, thumbnailWidth, thumbnailHeight, width, height\r\n) {\r\n\tconst nsSvg = 'http://www.w3.org/2000/svg',\r\n\t\tnsXlink = 'http://www.w3.org/1999/xlink';\r\n\r\n\t// We want to visually separate the image from the summary\r\n\t// Given we use an SVG mask, we cannot rely on border to do this\r\n\t// and instead must insert a polyline element to visually separate\r\n\tconst line = document.createElementNS( nsSvg, 'polyline' );\r\n\tconst isTall = className.indexOf( 'not-tall' ) === -1;\r\n\tconst points = isTall ? [ 0, 0, 0, height ] :\r\n\t\t[ 0, height - 1, width, height - 1 ];\r\n\r\n\tline.setAttribute( 'stroke', 'rgba(0,0,0,0.1)' );\r\n\tline.setAttribute( 'points', points.join( ' ' ) );\r\n\tline.setAttribute( 'stroke-width', 1 );\r\n\r\n\tconst thumbnailSVGImage = document.createElementNS( nsSvg, 'image' );\r\n\tthumbnailSVGImage.setAttributeNS( nsXlink, 'href', url );\r\n\t// The following classes are used here:\r\n\t// * mwe-popups-is-not-tall\r\n\t// * mwe-popups-is-tall\r\n\tthumbnailSVGImage.classList.add( className );\r\n\taddAttributes(\r\n\t\tthumbnailSVGImage,\r\n\t\t{\r\n\t\t\tx,\r\n\t\t\ty,\r\n\t\t\twidth: thumbnailWidth,\r\n\t\t\theight: thumbnailHeight\r\n\t\t}\r\n\t);\r\n\r\n\tconst thumbnail = document.createElementNS( nsSvg, 'svg' );\r\n\taddAttributes(\r\n\t\tthumbnail, {\r\n\t\t\txmlns: nsSvg,\r\n\t\t\twidth,\r\n\t\t\theight\r\n\t\t}\r\n\t);\r\n\tthumbnail.appendChild( thumbnailSVGImage );\r\n\tthumbnail.appendChild( line );\r\n\treturn thumbnail;\r\n}\r\n","/**\r\n * @module templateUtil\r\n * @private\r\n */\r\n\r\n/**\r\n * @param {string} str\r\n * @return {string} The string with any HTML entities escaped.\r\n */\r\nexport function escapeHTML( str ) {\r\n\treturn mw.html.escape( str );\r\n}\r\n\r\nconst templates = {};\r\n/**\r\n * @param {string} html markup of the template\r\n * @return {HTMLElement} a cloned root element of the template\r\n */\r\nexport function createNodeFromTemplate( html ) {\r\n\tif ( !templates[ html ] ) {\r\n\t\t// TODO: use <template> element when IE11 dies\r\n\t\tconst div = document.createElement( 'div' );\r\n\t\tdiv.innerHTML = html;\r\n\t\ttemplates[ html ] = div.firstElementChild;\r\n\t}\r\n\r\n\treturn templates[ html ].cloneNode( true );\r\n}\r\n","/**\r\n * @module popup\r\n * @private\r\n */\r\n\r\nimport { createNodeFromTemplate } from '../templateUtil';\r\n\r\nconst templateHTML = `\r\n\t<div class=\"mwe-popups\" aria-hidden></div>\r\n`;\r\n/**\r\n * @param {ext.popups.previewTypes} type\r\n * @param {HTMLElement} element The contents of the popup.\r\n * @return {HTMLElement}\r\n */\r\n\r\nexport function renderPopup( type, container ) {\r\n\tconst element = createNodeFromTemplate( templateHTML );\r\n\t// The following classes are used here:\r\n\t// * mwe-popups-type-reference\r\n\t// * mwe-popups-type-unknown\r\n\t// * mwe-popups-type-generic\r\n\t// * mwe-popups-type-disambiguation\r\n\telement.className = `mwe-popups mwe-popups-type-${ type }`;\r\n\tcontainer.className = 'mwe-popups-container';\r\n\telement.appendChild( container );\r\n\treturn element;\r\n}\r\n","/**\r\n * @module preview\r\n * @private\r\n */\r\n\r\nimport { renderPopup } from '../popup/popup';\r\nimport { createNodeFromTemplate, escapeHTML } from '../templateUtil';\r\n\r\nconst templateHTML = `\r\n\t<div class=\"mwe-popups-container\">\r\n\t\t<a class=\"mwe-popups-extract\">\r\n       \t\t<div class=\"mwe-popups-scroll\">\r\n\t\t\t\t<strong class=\"mwe-popups-title\">\r\n\t\t\t\t\t<span class=\"popups-icon\"></span>\r\n\t\t\t\t</strong>\r\n\t\t\t\t<div class=\"mwe-popups-message\"></div>\r\n\t\t\t</div>\r\n\t\t</a>\r\n\t\t<footer>\r\n\t\t\t<a class=\"mwe-popups-read-link\"></a>\r\n\t\t</footer>\r\n\t</div>\r\n`;\r\n\r\n/**\r\n * Render generic and disambiguation previews\r\n *\r\n * @param {ext.popups.PagePreviewModel} model\r\n * @param {string|null} message\r\n * @param {string} linkMsg\r\n * @return {jQuery}\r\n */\r\nexport function renderPreview(\r\n\tmodel, message, linkMsg\r\n) {\r\n\tconst popup = renderPopup( model.type, createNodeFromTemplate( templateHTML ) );\r\n\r\n\t// The following classes are used here:\r\n\t// * popups-icon--preview-unknown\r\n\t// * popups-icon--preview-generic\r\n\t// * popups-icon--preview-disambiguation\r\n\tpopup.querySelector( '.popups-icon' ).classList.add( `popups-icon--preview-${ model.type }` );\r\n\tpopup.querySelector( '.mwe-popups-extract' ).setAttribute( 'href', model.url );\r\n\tconst messageElement = popup.querySelector( '.mwe-popups-message' );\r\n\tif ( message ) {\r\n\t\tmessageElement.innerHTML = escapeHTML( message );\r\n\t} else {\r\n\t\tmessageElement.remove();\r\n\t}\r\n\tconst readLink = popup.querySelector( '.mwe-popups-read-link' );\r\n\treadLink.innerHTML = escapeHTML( linkMsg );\r\n\treadLink.setAttribute( 'href', model.url );\r\n\tconst title = popup.querySelector( '.mwe-popups-title' );\r\n\ttitle.innerHTML += escapeHTML( model.title );\r\n\treturn popup;\r\n}\r\n","export default function _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}","import arrayLikeToArray from \"./arrayLikeToArray.js\";\nexport default function _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return arrayLikeToArray(o, minLen);\n}","/**\n * @module pagePreview\n * @private\n */\n\nimport { renderPopup } from '../popup/popup';\nimport { escapeHTML, createNodeFromTemplate } from '../templateUtil';\n\nconst defaultExtractWidth = 215;\nconst templateHTML = `\n<div>\n    <a class=\"mwe-popups-discreet\"></a>\n    <a class=\"mwe-popups-extract\"></a>\n    <footer>\n\t\t<a class=\"cdx-button cdx-button--fake-button cdx-button--fake-button--enabled cdx-button--weight-quiet cdx-button--icon-only mwe-popups-settings-button\">\n\t\t\t<span class=\"popups-icon popups-icon--size-small popups-icon--settings\"></span>\n\t\t\t<span class=\"mwe-popups-settings-button-label\"></span>\n        </a>\n    </footer>\n</div>\n\t`;\n\n/**\n * @param {ext.popups.PagePreviewModel} model\n * @param {ext.popups.Thumbnail|null} thumbnail\n * @param {boolean} withCSSClipPath\n * @param {string} linkTitle\n * @return {HTMLElement}\n */\nexport function renderPagePreview(\n\tmodel, thumbnail, withCSSClipPath, linkTitle\n) {\n\tconst el = renderPopup( model.type, createNodeFromTemplate( templateHTML ) );\n\n\tconst linkDiscreet = el.querySelector( '.mwe-popups-discreet' );\n\tconst extract = el.querySelector( '.mwe-popups-extract' );\n\textract.setAttribute( 'href', model.url );\n\textract.setAttribute( 'target', '_blank' );\n\tlinkDiscreet.setAttribute( 'href', model.url );\n\tlinkDiscreet.setAttribute( 'target', '_blank' );\n\textract.setAttribute( 'dir', model.languageDirection );\n\textract.setAttribute( 'lang', model.languageCode );\n\n\tel.querySelector( '.mwe-popups-settings-button' )\n\t\t.setAttribute( 'title', linkTitle );\n\n\t// Set label on settings icon button\n\tconst labelText = escapeHTML( mw.msg( 'popups-settings-icon-gear-title' ) );\n\tconst label = el.querySelector( '.mwe-popups-settings-button-label' );\n\tlabel.textContent = labelText;\n\n\tif ( thumbnail ) {\n\t\tel.querySelector( '.mwe-popups-discreet' ).appendChild( thumbnail.el );\n\t} else {\n\t\tlinkDiscreet.remove();\n\t}\n\n\tif ( model.extract ) {\n\t\tif ( typeof model.extract === 'string' ) {\n\t\t\textract.innerHTML = model.extract;\n\t\t} else {\n\t\t\textract.append( ...model.extract );\n\t\t}\n\t\tconst extractWidth = getExtractWidth( thumbnail );\n\t\tif ( !withCSSClipPath ) {\n\t\t\textract.style.width = extractWidth;\n\t\t\tel.querySelector( 'footer' ).style.width = extractWidth;\n\t\t}\n\t}\n\n\treturn el;\n}\n\nexport { defaultExtractWidth }; // for testing\n\n/**\n * Calculates width of extract based on the associated thumbnail\n *\n * @param {ext.popups.Thumbnail|null} thumbnail model\n * @return {string} representing the css width attribute to be\n *   used for the extract\n */\nexport function getExtractWidth( thumbnail ) {\n\treturn thumbnail && thumbnail.isNarrow ? `${ defaultExtractWidth + thumbnail.offset }px` : '';\n}\n","import arrayWithoutHoles from \"./arrayWithoutHoles.js\";\nimport iterableToArray from \"./iterableToArray.js\";\nimport unsupportedIterableToArray from \"./unsupportedIterableToArray.js\";\nimport nonIterableSpread from \"./nonIterableSpread.js\";\nexport default function _toConsumableArray(arr) {\n  return arrayWithoutHoles(arr) || iterableToArray(arr) || unsupportedIterableToArray(arr) || nonIterableSpread();\n}","import arrayLikeToArray from \"./arrayLikeToArray.js\";\nexport default function _arrayWithoutHoles(arr) {\n  if (Array.isArray(arr)) return arrayLikeToArray(arr);\n}","export default function _iterableToArray(iter) {\n  if (typeof Symbol !== \"undefined\" && iter[Symbol.iterator] != null || iter[\"@@iterator\"] != null) return Array.from(iter);\n}","export default function _nonIterableSpread() {\n  throw new TypeError(\"Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}","import wait from '../wait';\r\nimport pointerMaskSVG from './pointer-mask.svg';\r\nimport { SIZES, createThumbnail } from './thumbnail';\r\nimport { renderPreview } from './templates/preview/preview';\r\nimport { renderPagePreview } from './templates/pagePreview/pagePreview';\r\n/**\r\n * @module renderer\r\n * @private\r\n */\r\nconst landscapePopupWidth = 450,\r\n\tportraitPopupWidth = 320,\r\n\tpointerSize = 8, // Height of the pointer.\r\n\tmaxLinkWidthForCenteredPointer = 28; // Link with roughly < 4 chars.\r\n\r\nexport { pointerSize, landscapePopupWidth, portraitPopupWidth }; // for use in storybook\r\n\r\n/**\r\n * @typedef {Object} ext.popups.Measures\r\n * @property {number} pageX\r\n * @property {number} pageY\r\n * @property {number} clientY\r\n * @property {ClientRectList} clientRects list of rectangles defined by\r\n *  four edges\r\n * @property {Object} offset\r\n * @property {number} width\r\n * @property {number} height\r\n * @property {number} scrollTop\r\n * @property {number} windowWidth\r\n * @property {number} windowHeight\r\n */\r\n\r\n/**\r\n * Extracted from `mw.popups.createSVGMasks`. This is just an SVG mask to point\r\n * or \"point\" at the link that's hovered over. The \"pointer\" appears to be cut\r\n * out of the image itself:\r\n *   _______                  link\r\n *  |       |    _/\\_____     _/\\____ <-- Pointer pointing at link\r\n *  |  :-]  | + |xxxxxxx   = |  :-]  |\r\n *  |_______|   |xxxxxxx     |_______|\r\n *              :\r\n *  Thumbnail    Pointer     Page preview\r\n *    image     clip-path   bubble w/ pointer\r\n *\r\n * SVG masks are used in place of CSS masks for browser support issues (see\r\n * https://caniuse.com/#feat=css-masks).\r\n *\r\n * @private\r\n * @param {Object} container DOM object to which pointer masks are appended\r\n */\r\nexport function createPointerMasks( container ) {\r\n\tconst node = document.createElement( 'div' );\r\n\tnode.setAttribute( 'id', 'mwe-popups-svg' );\r\n\tnode.innerHTML = pointerMaskSVG;\r\n\tcontainer.appendChild( node );\r\n}\r\n\r\n/**\r\n * Initializes the renderer.\r\n *\r\n */\r\nexport function init() {\r\n\tif ( !supportsCSSClipPath() ) {\r\n\t\tcreatePointerMasks( document.body );\r\n\t}\r\n}\r\n\r\n/**\r\n * The model of how a view is rendered, which is constructed from a response\r\n * from the gateway.\r\n *\r\n * TODO: Rename `isTall` to `isPortrait`.\r\n *\r\n * @typedef {Object} ext.popups.Preview\r\n * @property {jQuery} el\r\n * @property {boolean} hasThumbnail\r\n * @property {Object} thumbnail\r\n * @property {boolean} isTall Sugar around\r\n *  `preview.hasThumbnail && thumbnail.isTall`\r\n */\r\n\r\n/**\r\n * Renders a preview given data from the {@link gateway Gateway}.\r\n * The preview is rendered and added to the DOM but will remain hidden until\r\n * the `show` method is called.\r\n *\r\n * Previews are rendered at:\r\n *\r\n * # The position of the mouse when the user dwells on the link with their\r\n *   mouse.\r\n * # The centermost point of the link when the user dwells on the link with\r\n *   their keyboard or other assistive device.\r\n *\r\n * Since the content of the preview doesn't change but its position might, we\r\n * distinguish between \"rendering\" - generating HTML from a MediaWiki API\r\n * response - and \"showing/hiding\" - positioning the layout and changing its\r\n * orientation, if necessary.\r\n *\r\n * @param {ext.popups.PreviewModel} model\r\n * @return {ext.popups.Preview}\r\n */\r\nexport function render( model ) {\r\n\tconst preview = createPreviewWithType( model );\r\n\r\n\treturn {\r\n\t\t/**\r\n\t\t * Shows the preview given an event representing the user's interaction\r\n\t\t * with the active link, e.g. an instance of\r\n\t\t * [MouseEvent](https://developer.mozilla.org/en/docs/Web/API/MouseEvent).\r\n\t\t *\r\n\t\t * See `show` for more detail.\r\n\t\t *\r\n\t\t * @ignore\r\n\t\t * @param {Event} event\r\n\t\t * @param {Object} boundActions The\r\n\t\t *  [bound action creators](http://redux.js.org/docs/api/bindActionCreators.html)\r\n\t\t *  that were (likely) created in [boot.js](./boot.js).\r\n\t\t * @param {string} token The unique token representing the link interaction\r\n\t\t *  that resulted in showing the preview\r\n\t\t * @return {jQuery.Promise<void>}\r\n\t\t */\r\n\t\tshow( event, boundActions, token ) {\r\n\t\t\treturn show(\r\n\t\t\t\tpreview, event, event.target, boundActions, token,\r\n\t\t\t\tdocument.body, document.documentElement.getAttribute( 'dir' )\r\n\t\t\t);\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Hides the preview.\r\n\t\t *\r\n\t\t * See `hide` for more detail.\r\n\t\t *\r\n\t\t * @ignore\r\n\t\t * @return {jQuery.Promise<void>}\r\n\t\t */\r\n\t\thide() {\r\n\t\t\treturn hide( preview );\r\n\t\t}\r\n\t};\r\n}\r\n\r\nlet renderers = {};\r\nconst renderersMeta = {};\r\n\r\n/**\r\n * @param {string} type\r\n * @param {function( ext.popups.PreviewModel ): ext.popups.Preview} [previewFn]\r\n * @param {boolean} [doNotRequireSummary] does this type require a summary to be renderable?\r\n *\r\n */\r\nexport function registerPreviewUI( type, previewFn, doNotRequireSummary ) {\r\n\trenderers[ type ] = previewFn || createPagePreview;\r\n\trenderersMeta[ type ] = {\r\n\t\trequireSummary: !doNotRequireSummary\r\n\t};\r\n}\r\n\r\n/**\r\n * Check whether this render type requires a summary to be rendered.\r\n *\r\n * @param {string} type of preview\r\n * @return {boolean}\r\n */\r\nexport function requiresSummary( type ) {\r\n\tconst meta = renderersMeta[ type ] || { requireSummary: true };\r\n\treturn meta.requireSummary;\r\n}\r\n\r\n/**\r\n * Creates an instance of a Preview based on\r\n * the type property of the PreviewModel\r\n *\r\n * @param {ext.popups.PreviewModel} model\r\n * @return {ext.popups.Preview}\r\n */\r\nexport function createPreviewWithType( model ) {\r\n\tconst fn = renderers[ model.type ] || createEmptyPreview;\r\n\treturn fn( model );\r\n}\r\n\r\nfunction supportsCSSClipPath() {\r\n\treturn window.CSS &&\r\n\t\ttypeof CSS.supports === 'function' &&\r\n\t\tCSS.supports( 'clip-path', 'polygon(1px 1px)' );\r\n\r\n}\r\n\r\n/**\r\n * Creates an instance of the DTO backing a preview.\r\n *\r\n * @param {ext.popups.PagePreviewModel} model\r\n * @return {ext.popups.Preview}\r\n */\r\nexport function createPagePreview( model ) {\r\n\tconst thumbnail = createThumbnail( model.thumbnail, supportsCSSClipPath() ),\r\n\t\thasThumbnail = thumbnail !== null,\r\n\t\twithCSSClipPath = supportsCSSClipPath(),\r\n\t\tlinkTitle = mw.msg( 'popups-settings-icon-gear-title' );\r\n\r\n\treturn {\r\n\t\tel: renderPagePreview( model, thumbnail, withCSSClipPath, linkTitle ),\r\n\t\thasThumbnail,\r\n\t\tthumbnail,\r\n\t\tisTall: hasThumbnail && thumbnail.isTall\r\n\t};\r\n}\r\n\r\n/**\r\n * Creates an instance of the DTO backing a preview. In this case the DTO\r\n * represents a generic preview, which covers the following scenarios:\r\n *\r\n * * The page doesn't exist, i.e. the user hovered over a redlink or a\r\n *   redirect to a page that doesn't exist.\r\n * * The page doesn't have a viable extract.\r\n *\r\n * @param {ext.popups.PagePreviewModel} model\r\n * @return {ext.popups.Preview}\r\n */\r\nexport function createEmptyPreview( model ) {\r\n\tmodel.title = mw.msg( 'popups-preview-no-preview' );\r\n\tconst linkMsg = mw.msg( 'popups-preview-footer-read' );\r\n\r\n\treturn {\r\n\t\tel: renderPreview( model, null, linkMsg ),\r\n\t\thasThumbnail: false,\r\n\t\tisTall: false\r\n\t};\r\n}\r\n\r\n/**\r\n * Creates an instance of the disambiguation preview.\r\n *\r\n * @param {ext.popups.PagePreviewModel} model\r\n * @return {ext.popups.Preview}\r\n */\r\nexport function createDisambiguationPreview( model ) {\r\n\tconst extractMsg = mw.msg( 'popups-preview-disambiguation' );\r\n\tconst linkMsg = mw.msg( 'popups-preview-disambiguation-link' );\r\n\r\n\treturn {\r\n\t\tel: renderPreview( model, extractMsg, linkMsg ),\r\n\t\thasThumbnail: false,\r\n\t\tisTall: false\r\n\t};\r\n}\r\n\r\n/**\r\n * Shows the preview.\r\n *\r\n * Extracted from `mw.popups.render.openPopup`.\r\n *\r\n * TODO: From the perspective of the client, there's no need to distinguish\r\n * between rendering and showing a preview. Merge #render and Preview#show.\r\n *\r\n * @private\r\n * @ignore\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.Measures} measures\r\n * @param {HTMLElement} _link event target (unused)\r\n * @param {ext.popups.PreviewBehavior} behavior\r\n * @param {string} token\r\n * @param {Object} container DOM object to which pointer masks are appended\r\n * @param {string} dir 'ltr' if left-to-right, 'rtl' if right-to-left.\r\n * @return {jQuery.Promise<void>} A promise that resolves when the promise has\r\n *                                faded in.\r\n */\r\nexport function show(\r\n\tpreview, measures, _link, behavior, token, container, dir\r\n) {\r\n\tconst layout = createLayout(\r\n\t\tpreview.isTall,\r\n\t\tmeasures,\r\n\t\tpointerSize,\r\n\t\tdir\r\n\t);\r\n\r\n\tcontainer.appendChild( preview.el );\r\n\r\n\tlayoutPreview(\r\n\t\tpreview, layout, getClasses( preview, layout ),\r\n\t\tSIZES.landscapeImage.h, pointerSize, measures.windowHeight\r\n\t);\r\n\r\n\tpreview.el.style.display = 'block';\r\n\r\n\t// Trigger fading effect for reference previews after the popup has been rendered\r\n\tif ( preview.el.classList.contains( 'mwe-popups-type-reference' ) ) {\r\n\t\tpreview.el.querySelector( '.mwe-popups-scroll' ).dispatchEvent( new Event( 'scroll' ) );\r\n\t}\r\n\r\n\treturn wait( 200 )\r\n\t\t.then( () => {\r\n\t\t\tbindBehavior( preview, behavior );\r\n\t\t\tbehavior.previewShow( token );\r\n\t\t} );\r\n}\r\n\r\n/**\r\n * Binds the behavior to the interactive elements of the preview.\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.PreviewBehavior} behavior\r\n */\r\nexport function bindBehavior( preview, behavior ) {\r\n\tpreview.el.addEventListener( 'mouseenter', behavior.previewDwell );\r\n\tpreview.el.addEventListener( 'mouseleave', behavior.previewAbandon );\r\n\r\n\tpreview.el.addEventListener( 'click', behavior.click );\r\n\r\n\tconst button = preview.el.querySelector( 'a.mwe-popups-settings-button' );\r\n\tif ( button ) {\r\n\t\tbutton.href = behavior.settingsUrl;\r\n\t\tbutton.addEventListener( 'click', ( event ) => {\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tbehavior.showSettings( event );\r\n\t\t} );\r\n\t}\r\n}\r\n\r\n/**\r\n * Extracted from `mw.popups.render.closePopup`.\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @return {jQuery.Promise<void>} A promise that resolves when the preview has\r\n *                                faded out.\r\n */\r\nexport function hide( preview ) {\r\n\t// FIXME: This method clearly needs access to the layout of the preview.\r\n\tconst fadeInClass = ( preview.el.classList.contains( 'mwe-popups-fade-in-up' ) ) ?\r\n\t\t'mwe-popups-fade-in-up' :\r\n\t\t'mwe-popups-fade-in-down';\r\n\r\n\tconst fadeOutClass = ( fadeInClass === 'mwe-popups-fade-in-up' ) ?\r\n\t\t'mwe-popups-fade-out-down' :\r\n\t\t'mwe-popups-fade-out-up';\r\n\r\n\t// Classes documented above\r\n\t// eslint-disable-next-line mediawiki/class-doc\r\n\tpreview.el.classList.remove( fadeInClass );\r\n\t// eslint-disable-next-line mediawiki/class-doc\r\n\tpreview.el.classList.add( fadeOutClass );\r\n\r\n\treturn wait( 150 ).then( () => {\r\n\t\tpreview.el.remove();\r\n\t} );\r\n}\r\n\r\n/**\r\n * Represents the layout of a preview, which consists of a position (`offset`)\r\n * and whether or not the preview should be flipped horizontally or\r\n * vertically (`flippedX` and `flippedY` respectively).\r\n *\r\n * @typedef {Object} ext.popups.PreviewLayout\r\n * @property {Object} offset\r\n * @property {number} offset.top\r\n * @property {number} offset.left\r\n * @property {boolean} flippedX\r\n * @property {boolean} flippedY\r\n * @property {string} dir 'ltr' if left-to-right, 'rtl' if right-to-left.\r\n */\r\n\r\n/**\r\n * @param {boolean} isPreviewTall\r\n * @param {ext.popups.Measures} measures\r\n * @param {number} pointerSpaceSize Space reserved for the pointer\r\n * @param {string} dir 'ltr' if left-to-right, 'rtl' if right-to-left.\r\n * @return {ext.popups.PreviewLayout}\r\n */\r\nexport function createLayout(\r\n\tisPreviewTall, measures, pointerSpaceSize, dir\r\n) {\r\n\tlet flippedX = false,\r\n\t\tflippedY = false,\r\n\t\toffsetTop = measures.pageY ?\r\n\t\t\t// If it was a mouse event, position according to mouse\r\n\t\t\t// Since client rectangles are relative to the viewport,\r\n\t\t\t// take scroll position into account.\r\n\t\t\tgetClosestYPosition(\r\n\t\t\t\tmeasures.pageY - measures.scrollTop,\r\n\t\t\t\tmeasures.clientRects,\r\n\t\t\t\tfalse\r\n\t\t\t) + measures.scrollTop + pointerSpaceSize :\r\n\t\t\t// Position according to link position or size\r\n\t\t\tmeasures.offset.top + measures.height + pointerSize,\r\n\t\toffsetLeft;\r\n\tconst clientTop = measures.clientY ? measures.clientY : offsetTop - measures.scrollTop;\r\n\r\n\tif ( measures.pageX ) {\r\n\t\tif ( measures.width > maxLinkWidthForCenteredPointer ) {\r\n\t\t\t// For wider links, position the popup's pointer at the\r\n\t\t\t// mouse pointer's location. (x-axis)\r\n\t\t\toffsetLeft = measures.pageX;\r\n\t\t} else {\r\n\t\t\t// For smaller links, position the popup's pointer at\r\n\t\t\t// the link's center. (x-axis)\r\n\t\t\toffsetLeft = measures.offset.left + measures.width / 2;\r\n\t\t}\r\n\t} else {\r\n\t\toffsetLeft = measures.offset.left;\r\n\t}\r\n\r\n\t// X Flip\r\n\tif ( offsetLeft > ( measures.windowWidth / 2 ) ) {\r\n\t\toffsetLeft += ( !measures.pageX ) ? measures.width : 0;\r\n\t\toffsetLeft -= !isPreviewTall ?\r\n\t\t\tportraitPopupWidth :\r\n\t\t\tlandscapePopupWidth;\r\n\t\tflippedX = true;\r\n\t}\r\n\r\n\tif ( measures.pageX ) {\r\n\t\toffsetLeft += ( flippedX ) ? 18 : -18;\r\n\t}\r\n\r\n\t// Y Flip\r\n\tif ( clientTop > ( measures.windowHeight / 2 ) ) {\r\n\t\tflippedY = true;\r\n\r\n\t\t// Mirror the positioning of the preview when there's no \"Y flip\": rest\r\n\t\t// the pointer on the edge of the link's bounding rectangle. In this case\r\n\t\t// the edge is the top-most.\r\n\t\toffsetTop = measures.offset.top;\r\n\r\n\t\t// Change the Y position to the top of the link\r\n\t\tif ( measures.pageY ) {\r\n\t\t\t// Since client rectangles are relative to the viewport,\r\n\t\t\t// take scroll position into account.\r\n\t\t\toffsetTop = getClosestYPosition(\r\n\t\t\t\tmeasures.pageY - measures.scrollTop,\r\n\t\t\t\tmeasures.clientRects,\r\n\t\t\t\ttrue\r\n\t\t\t) + measures.scrollTop;\r\n\t\t}\r\n\r\n\t\toffsetTop -= pointerSpaceSize;\r\n\t}\r\n\r\n\treturn {\r\n\t\toffset: {\r\n\t\t\ttop: offsetTop,\r\n\t\t\tleft: offsetLeft\r\n\t\t},\r\n\t\tflippedX: dir === 'rtl' ? !flippedX : flippedX,\r\n\t\tflippedY,\r\n\t\tdir\r\n\t};\r\n}\r\n\r\n/**\r\n * is there a pointer on the image of the preview?\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.PreviewLayout} layout\r\n * @return {boolean}\r\n */\r\nexport function hasPointerOnImage( preview, layout ) {\r\n\tif ( ( !preview.hasThumbnail || preview.isTall && !layout.flippedX ) &&\r\n\t\t!layout.flippedY ) {\r\n\t\treturn false;\r\n\t}\r\n\tif ( preview.hasThumbnail ) {\r\n\t\tif (\r\n\t\t\t( !preview.isTall && !layout.flippedY ) ||\r\n\t\t\t( preview.isTall && layout.flippedX )\r\n\t\t) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n/**\r\n * Generates a list of declarative CSS classes that represent the layout of\r\n * the preview.\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.PreviewLayout} layout\r\n * @return {string[]}\r\n */\r\nexport function getClasses( preview, layout ) {\r\n\tconst classes = [];\r\n\r\n\tif ( layout.flippedY ) {\r\n\t\tclasses.push( 'mwe-popups-fade-in-down' );\r\n\t} else {\r\n\t\tclasses.push( 'mwe-popups-fade-in-up' );\r\n\t}\r\n\r\n\tif ( layout.flippedY && layout.flippedX ) {\r\n\t\tclasses.push( 'flipped-x-y' );\r\n\t} else if ( layout.flippedY ) {\r\n\t\tclasses.push( 'flipped-y' );\r\n\t} else if ( layout.flippedX ) {\r\n\t\tclasses.push( 'flipped-x' );\r\n\t}\r\n\r\n\tclasses.push(\r\n\t\thasPointerOnImage( preview, layout ) ?\r\n\t\t\t'mwe-popups-image-pointer' : 'mwe-popups-no-image-pointer'\r\n\t);\r\n\r\n\tif ( preview.isTall ) {\r\n\t\tclasses.push( 'mwe-popups-is-tall' );\r\n\t} else {\r\n\t\tclasses.push( 'mwe-popups-is-not-tall' );\r\n\t}\r\n\r\n\treturn classes;\r\n}\r\n\r\n/**\r\n * Lays out the preview given the layout.\r\n *\r\n * If the thumbnail is landscape and isn't the full height of the thumbnail\r\n * container, then pull the extract up to keep whitespace consistent across\r\n * previews.\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.PreviewLayout} layout\r\n * @param {string[]} classes class names used for layout out the preview\r\n * @param {number} predefinedLandscapeImageHeight landscape image height\r\n * @param {number} pointerSpaceSize\r\n * @param {number} windowHeight\r\n */\r\nexport function layoutPreview(\r\n\tpreview, layout, classes, predefinedLandscapeImageHeight, pointerSpaceSize, windowHeight\r\n) {\r\n\tconst popup = preview.el,\r\n\t\tisTall = preview.isTall,\r\n\t\thasThumbnail = preview.hasThumbnail,\r\n\t\tthumbnail = preview.thumbnail,\r\n\t\tflippedY = layout.flippedY;\r\n\r\n\tif (\r\n\t\t!flippedY && !isTall && hasThumbnail &&\r\n\t\t\tthumbnail.height < predefinedLandscapeImageHeight && !supportsCSSClipPath()\r\n\t) {\r\n\t\tconst popupExtract = popup.querySelector( '.mwe-popups-extract' );\r\n\t\tpopupExtract.style.marginTop = `${ ( thumbnail.height - pointerSpaceSize ) }px`;\r\n\t}\r\n\r\n\t// The following classes are used here:\r\n\t// * flipped-x\r\n\t// * flipped-x-y\r\n\t// * flipped-y\r\n\t// * mwe-popups-fade-in-down\r\n\t// * mwe-popups-fade-in-up\r\n\t// * mwe-popups-image-pointer\r\n\t// * mwe-popups-is-not-tall\r\n\t// * mwe-popups-is-tall\r\n\t// * mwe-popups-no-image-pointer\r\n\tpopup.classList.add.apply( popup.classList, classes );\r\n\r\n\tpopup.style.left = `${ layout.offset.left }px`;\r\n\tpopup.style.top = flippedY ? 'auto' : `${ layout.offset.top }px`;\r\n\tpopup.style.bottom = flippedY ? `${ windowHeight - layout.offset.top }px` : 'auto';\r\n\r\n\tif ( hasThumbnail && !supportsCSSClipPath() ) {\r\n\t\tsetThumbnailClipPath( preview, layout );\r\n\t}\r\n}\r\n\r\n/**\r\n * Sets the thumbnail SVG clip-path.\r\n *\r\n * If the preview should be oriented differently, then the pointer is updated,\r\n * e.g. if the preview should be flipped vertically, then the pointer is\r\n * removed.\r\n *\r\n * Note: SVG clip-paths are supported everywhere but clip-paths as CSS\r\n * properties are not (https://caniuse.com/#feat=css-clip-path). For this\r\n * reason, RTL flipping is handled in JavaScript instead of CSS.\r\n *\r\n * @param {ext.popups.Preview} preview\r\n * @param {ext.popups.PreviewLayout} layout\r\n */\r\nexport function setThumbnailClipPath(\r\n\t{ el, isTall, thumbnail }, { flippedY, flippedX, dir }\r\n) {\r\n\tconst maskID = getThumbnailClipPathID( isTall, flippedY, flippedX );\r\n\tif ( maskID ) {\r\n\t\t// CSS matrix transform entries:\r\n\t\t//  sx c tx \r\n\t\t//  sy d ty \r\n\t\tconst matrix = {\r\n\t\t\tscaleX: 1,\r\n\t\t\t// moving the mask horizontally if the image is less than the maximum width\r\n\t\t\ttranslateX: isTall ? Math.min( thumbnail.width - SIZES.portraitImage.w, 0 ) : 0\r\n\t\t};\r\n\r\n\t\tif ( dir === 'rtl' ) {\r\n\t\t\t// flipping the mask horizontally\r\n\t\t\tmatrix.scaleX = -1;\r\n\t\t\t// moving the mask horizontally to the max width of the thumbnail\r\n\t\t\tmatrix.translateX = isTall ? SIZES.portraitImage.w : SIZES.landscapeImage.w;\r\n\t\t}\r\n\r\n\t\t// Transform the clip-path not the image it is applied to.\r\n\t\tconst mask = document.getElementById( maskID );\r\n\t\tmask.setAttribute(\r\n\t\t\t'transform',\r\n\t\t\t`matrix(${ matrix.scaleX } 0 0 1 ${ matrix.translateX } 0)`\r\n\t\t);\r\n\r\n\t\tel.querySelector( 'image' )\r\n\t\t\t.setAttribute( 'clip-path', `url(#${ maskID })` );\r\n\t}\r\n}\r\n\r\n/**\r\n * Gets the thumbnail SVG clip-path element ID as specified in pointer-mask.svg.\r\n *\r\n * @param {boolean} isTall Sugar around\r\n *  `preview.hasThumbnail && thumbnail.isTall`\r\n * @param {boolean} flippedY\r\n * @param {boolean} flippedX\r\n * @return {string|undefined}\r\n */\r\nexport function getThumbnailClipPathID( isTall, flippedY, flippedX ) {\r\n\t// Clip-paths are only needed when the pointer is in a corner that is covered by the thumbnail.\r\n\t// This is only the case in 4 of 8 situations:\r\n\tif ( !isTall && !flippedY ) {\r\n\t\t// 1. Landscape thumbnails cover the upper half of the popup. This is only the case when the\r\n\t\t// pointer is not flipped to the bottom.\r\n\t\treturn flippedX ? 'mwe-popups-mask-flip' : 'mwe-popups-mask';\r\n\t} else if ( isTall && flippedX ) {\r\n\t\t// 2. Tall thumbnails cover the right half of the popup. This is only the case when the\r\n\t\t// pointer is flipped to the right.\r\n\t\treturn flippedY ? 'mwe-popups-landscape-mask-flip' : 'mwe-popups-landscape-mask';\r\n\t}\r\n\r\n\t// The 4 combinations not covered above don't need a clip-path.\r\n\treturn undefined;\r\n}\r\n\r\n/**\r\n * Given the rectangular box(es) find the 'y' boundary of the closest\r\n * rectangle to the point 'y'. The point 'y' is the location of the mouse\r\n * on the 'y' axis and the rectangular box(es) are the borders of the\r\n * element over which the mouse is located. There will be more than one\r\n * rectangle in case the element spans multiple lines.\r\n *\r\n * In the majority of cases the mouse pointer will be inside a rectangle.\r\n * However, some browsers (i.e. Chrome) trigger a hover action even when\r\n * the mouse pointer is just outside a bounding rectangle. That's why\r\n * we need to look at all rectangles and not just the rectangle that\r\n * encloses the point.\r\n *\r\n * @private\r\n * @param {number} y the point for which the closest location is being\r\n *  looked for\r\n * @param {ClientRectList} rects list of rectangles defined by four edges\r\n * @param {boolean} [isTop] should the resulting rectangle's top 'y'\r\n *  boundary be returned. By default the bottom 'y' value is returned.\r\n * @return {number}\r\n */\r\nexport function getClosestYPosition( y, rects, isTop ) {\r\n\tlet minY = null, result;\r\n\r\n\tArray.prototype.slice.call( rects ).forEach( ( rect ) => {\r\n\t\tconst deltaY = Math.abs( y - rect.top + y - rect.bottom );\r\n\r\n\t\tif ( minY === null || minY > deltaY ) {\r\n\t\t\tminY = deltaY;\r\n\t\t\t// Make sure the resulting point is at or outside the rectangle\r\n\t\t\t// boundaries.\r\n\t\t\tresult = ( isTop ) ? Math.floor( rect.top ) : Math.ceil( rect.bottom );\r\n\t\t}\r\n\t} );\r\n\r\n\treturn result;\r\n}\r\n\r\nexport const test = {\r\n\t/**\r\n\t * For testing only\r\n\t * @private\r\n\t */\r\n\treset: () => {\r\n\t\trenderers = {};\r\n\t}\r\n};\r\n","/**\r\n * @module preview/model\r\n * @private\r\n */\r\n\r\nimport { requiresSummary } from '../ui/renderer';\r\n\r\nconst selectors = [];\r\n\r\n/**\r\n * Page Preview types as defined in Schema:Popups\r\n * https://meta.wikimedia.org/wiki/Schema:Popups\r\n *\r\n * @constant {Object}\r\n */\r\nconst previewTypes = {\r\n\t/** Empty preview used in error situations */\r\n\tTYPE_GENERIC: 'generic',\r\n\t/** Standard page preview with or without thumbnail */\r\n\tTYPE_PAGE: 'page',\r\n\t/** Disambiguation page preview */\r\n\tTYPE_DISAMBIGUATION: 'disambiguation'\r\n};\r\n\r\nexport { previewTypes };\r\n\r\n/**\r\n * Preview Model\r\n *\r\n * @typedef {Object} PreviewModel\r\n * @property {string} url The canonical URL of the page being previewed\r\n * @property {string} type One of the previewTypes.TYPE_ constants.\r\n */\r\n\r\n/**\r\n * @typedef {Object} PagePreviewModel\r\n * @extends PreviewModel\r\n * @property {string} title\r\n * @property {Array|undefined} extract `undefined` if the extract isn't\r\n *  viable, e.g. if it's empty after having ellipsis and parentheticals\r\n *  removed; this can be used to present default or error states\r\n * @property {string} languageCode\r\n * @property {string} languageDirection Either \"ltr\" or \"rtl\", or an empty string if undefined.\r\n * @property {{source: string, width: number, height: number}|undefined} thumbnail\r\n * @property {number} pageId Currently not used by any known popup type.\r\n */\r\n\r\n/**\r\n * @typedef {Object} ReferencePreviewModel\r\n * @extends PreviewModel\r\n * @property {string} extract An HTML snippet, not necessarily with a single top-level node\r\n * @property {string} referenceType A type identifier, e.g. \"web\"\r\n * @property {string} sourceElementId ID of the parent element that triggered the preview\r\n */\r\n\r\n/**\r\n * Creates a page preview model.\r\n *\r\n * @param {string} title\r\n * @param {string} url The canonical URL of the page being previewed\r\n * @param {string} languageCode\r\n * @param {string} languageDirection Either \"ltr\" or \"rtl\"\r\n * @param {Array|undefined|null} extract\r\n * @param {string} type\r\n * @param {{source: string, width: number, height: number}|undefined} [thumbnail]\r\n * @param {number} [pageId]\r\n * @return {PagePreviewModel}\r\n */\r\nexport function createModel(\r\n\ttitle,\r\n\turl,\r\n\tlanguageCode,\r\n\tlanguageDirection,\r\n\textract,\r\n\ttype,\r\n\tthumbnail,\r\n\tpageId\r\n) {\r\n\tconst processedExtract = processExtract( extract ),\r\n\t\tpreviewType = getPagePreviewType( type, processedExtract );\r\n\r\n\treturn {\r\n\t\ttitle,\r\n\t\turl,\r\n\t\tlanguageCode,\r\n\t\tlanguageDirection,\r\n\t\textract: processedExtract,\r\n\t\ttype: previewType,\r\n\t\tthumbnail,\r\n\t\tpageId\r\n\t};\r\n}\r\n\r\n/**\r\n * Creates an empty page preview model.\r\n *\r\n * @param {string} title\r\n * @param {string} url\r\n * @return {PagePreviewModel}\r\n */\r\nexport function createNullModel( title, url ) {\r\n\treturn createModel( title, url, '', '', [], '' );\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} element\r\n * @param {string} selector\r\n * @return {boolean}\r\n */\r\nconst elementMatchesSelector = ( element, selector ) => {\r\n\treturn element.matches( selector );\r\n};\r\n\r\n/**\r\n * Recursively checks the element and its parents.\r\n *\r\n * @param {HTMLElement} element\r\n * @return {HTMLElement|null}\r\n */\r\nexport function findNearestEligibleTarget( element ) {\r\n\tif ( selectors.length ) {\r\n\t\tconst selector = selectors.join( ', ' );\r\n\t\treturn element.closest( selector );\r\n\t}\r\n\treturn null;\r\n}\r\n\r\n/**\r\n * @typedef {Object} PreviewType\r\n * @property {string} name identifier for preview type\r\n * @property {string} selector a CSS selector\r\n * @type {PreviewType[]}\r\n */\r\nconst registeredPreviewTypes = [];\r\n\r\n/**\r\n * Determines the applicable popup type based on title and link element.\r\n *\r\n * @param {HTMLAnchorElement} el\r\n * @return {string|null} One of the previewTypes.TYPE_ constants\r\n */\r\nexport function getPreviewType( el ) {\r\n\tconst candidates = registeredPreviewTypes.filter(\r\n\t\t( type ) => elementMatchesSelector( el, type.selector )\r\n\t);\r\n\r\n\t// If the filter returned some possibilities, use the last registered one.\r\n\tif ( candidates.length > 0 ) {\r\n\t\treturn candidates[ candidates.length - 1 ].name;\r\n\t}\r\n\r\n\treturn null;\r\n}\r\n\r\n/**\r\n * Processes the extract returned by the TextExtracts MediaWiki API query\r\n * module.\r\n *\r\n * If the extract is `undefined`, `null`, or empty, then `undefined` is\r\n * returned.\r\n *\r\n * @param {Array|undefined|null} extract\r\n * @return {Array|undefined} Array when extract is an not empty array, undefined\r\n *  otherwise\r\n */\r\nfunction processExtract( extract ) {\r\n\tif ( extract === undefined || extract === null || extract.length === 0 ) {\r\n\t\treturn undefined;\r\n\t}\r\n\treturn extract;\r\n}\r\n\r\n/**\r\n * Determines the page preview type based on whether or not:\r\n * a. Is the preview empty.\r\n * b. The preview type matches one of previewTypes.\r\n * c. Assume standard page preview if both above are false\r\n *\r\n * @param {string} type\r\n * @param {Array|undefined} [processedExtract]\r\n * @return {string} One of the previewTypes.TYPE_ constants.\r\n */\r\n\r\nfunction getPagePreviewType( type, processedExtract ) {\r\n\t// If the preview type requires a summary to display and no extract was\r\n\t// found show the generic (error) preview.\r\n\tif ( processedExtract === undefined && requiresSummary( type ) ) {\r\n\t\treturn previewTypes.TYPE_GENERIC;\r\n\t}\r\n\r\n\tswitch ( type ) {\r\n\t\tcase previewTypes.TYPE_GENERIC:\r\n\t\tcase previewTypes.TYPE_DISAMBIGUATION:\r\n\t\tcase previewTypes.TYPE_PAGE:\r\n\t\t\treturn type;\r\n\t\tdefault:\r\n\t\t\t/**\r\n\t\t\t * Assume type=\"page\" if extract exists & not one of previewTypes.\r\n\t\t\t * Note:\r\n\t\t\t * - Restbase response includes \"type\" prop but other gateways don't.\r\n\t\t\t * - event-logging Schema:Popups requires type=\"page\" but restbase\r\n\t\t\t * provides type=\"standard\". Model must conform to event-logging schema.\r\n\t\t\t */\r\n\t\t\treturn previewTypes.TYPE_PAGE;\r\n\t}\r\n}\r\n\r\nconst dwellDelay = {};\r\n\r\n/**\r\n * Determines the delay before showing the preview when dwelling a link.\r\n *\r\n * @param {string} type\r\n * @return {number}\r\n */\r\nexport function getDwellDelay( type ) {\r\n\treturn dwellDelay[ type ] || 0;\r\n}\r\n\r\n/***\r\n * Set the delay before showing the preview when dwelling a link.\r\n *\r\n * @param {string} type\r\n * @param {number} delay\r\n */\r\nexport function setDwellTime( type, delay ) {\r\n\tdwellDelay[ type ] = delay;\r\n}\r\n\r\n/**\r\n * Allows extensions to register their own page previews.\r\n *\r\n * @stable\r\n * @param {string} type\r\n * @param {string} selector A valid CSS selector to associate preview with\r\n * @param {number} [delay] optional delay between hovering and displaying preview.\r\n *  If not defined, delay will be zero.\r\n */\r\nexport function registerModel( type, selector, delay ) {\r\n\tselectors.push( selector );\r\n\tregisteredPreviewTypes.push( {\r\n\t\tname: type,\r\n\t\tselector\r\n\t} );\r\n\tif ( delay ) {\r\n\t\tsetDwellTime( type, delay );\r\n\t}\r\n}\r\n\r\nexport const test = {\r\n\t/** For testing only */\r\n\treset: () => {\r\n\t\twhile ( registeredPreviewTypes.length ) {\r\n\t\t\tregisteredPreviewTypes.pop();\r\n\t\t}\r\n\t}\r\n};\r\n","/**\r\n * @module formatter\r\n * @private\r\n */\r\n\r\n/**\r\n * Improves the plain text extracts\r\n *\r\n * @param {string} plainTextExtract\r\n * @param {string} title\r\n * @return {Array}\r\n */\r\nexport function formatPlainTextExtract( plainTextExtract, title ) {\r\n\tlet extract = plainTextExtract;\r\n\tif ( plainTextExtract === undefined ) {\r\n\t\treturn [];\r\n\t}\r\n\r\n\t// After cleaning the extract it may have been blanked\r\n\tif ( extract.length === 0 ) {\r\n\t\treturn [];\r\n\t}\r\n\r\n\textract = makeTitleInExtractBold( extract, title );\r\n\treturn extract;\r\n}\r\n\r\n/**\r\n * Converts the extract into a list of elements, which correspond to fragments\r\n * of the extract. Fragments that match the title verbatim are wrapped in a\r\n * `<b>` element.\r\n *\r\n * Using the bolded elements of the extract of the page directly is covered by\r\n * [T141651](https://phabricator.wikimedia.org/T141651).\r\n *\r\n * Extracted from `mw.popups.renderer.article.getProcessedElements`.\r\n *\r\n * @param {string} extract\r\n * @param {string} title\r\n * @return {Array} A set of HTML Elements\r\n */\r\nfunction makeTitleInExtractBold( extract, title ) {\r\n\tconst elements = [],\r\n\t\tboldIdentifier = `<bi-${ Math.random() }>`,\r\n\t\tsnip = `<snip-${ Math.random() }>`;\r\n\r\n\ttitle = title.replace( /\\s+/g, ' ' ).trim(); // Remove extra white spaces\r\n\tconst escapedTitle = mw.util.escapeRegExp( title );\r\n\t// eslint-disable-next-line security/detect-non-literal-regexp\r\n\tconst regExp = new RegExp( `(^|\\\\s)(${ escapedTitle })(|$)`, 'i' );\r\n\r\n\t// Remove text in parentheses along with the parentheses\r\n\textract = extract.replace( /\\s+/, ' ' ); // Remove extra white spaces\r\n\r\n\t// Make title bold in the extract text\r\n\t// As the extract is html escaped there can be no such string in it\r\n\t// Also, the title is escaped of RegExp elements thus can't have \"*\"\r\n\textract = extract.replace(\r\n\t\tregExp,\r\n\t\t`$1${ snip }${ boldIdentifier }$2${ snip }$3`\r\n\t);\r\n\textract = extract.split( snip );\r\n\r\n\textract.forEach( ( part ) => {\r\n\t\tif ( part.indexOf( boldIdentifier ) === 0 ) {\r\n\t\t\tconst highlightNode = document.createElement( 'b' );\r\n\t\t\thighlightNode.textContent = part.slice( boldIdentifier.length );\r\n\t\t\telements.push( highlightNode );\r\n\t\t} else {\r\n\t\t\telements.push( document.createTextNode( part ) );\r\n\t\t}\r\n\t} );\r\n\r\n\treturn elements;\r\n}\r\n","/**\r\n * @module gateway\r\n * @private\r\n */\r\n\r\n/**\r\n * The interface implemented by all preview gateways.\r\n *\r\n * @typedef Gateway\r\n * @property {function(string): JQuery.jqXHR} fetch\r\n * @property {FetchPreviewForTitle} fetchPreviewForTitle\r\n * @property {ConvertPageToModel} convertPageToModel\r\n */\r\n\r\n/**\r\n * A Promise, usually for a long running or costly task such as an HTTP request,\r\n * that is abortable.\r\n *\r\n * @template T\r\n * @typedef {Promise<T>} AbortPromise\r\n * @property {function(): void} abort\r\n */\r\n\r\n/**\r\n * @stable this function is available to 3rd parties. Any breaking changes must\r\n *  go through the MediaWiki deprecation process.\r\n * @param {Promise|jQuery.Promise<T>} promise\r\n * @param {function(): void} [abort]\r\n * @return {AbortPromise}\r\n */\r\nexport function abortablePromise( promise, abort = () => {} ) {\r\n\t// JQuery provided.\r\n\tif ( promise.promise ) {\r\n\t\treturn promise.promise( {\r\n\t\t\tabort\r\n\t\t} );\r\n\t}\r\n\tpromise.abort = abort;\r\n\treturn promise;\r\n}\r\n\r\n/**\r\n * Fetches a preview for a page or reference.\r\n *\r\n * If the underlying request is successful and contains data for the requested title,\r\n * then the resulting promise will resolve. If not, then it will reject.\r\n *\r\n * @typedef {function(mw.Title, HTMLAnchorElement): AbortPromise<PreviewModel>} FetchPreviewForTitle\r\n */\r\n\r\n/**\r\n * Converts the API response to a preview model. Exposed for testing only.\r\n *\r\n * @typedef {function(Object, ...any): PagePreviewModel} ConvertPageToModel\r\n */\r\n\r\nconst gatewayMap = {};\r\n\r\n/**\r\n * @param {string} type Type of preview we are handling\r\n * @return {Gateway|undefined}\r\n */\r\nexport function getGatewayForPreviewType( type ) {\r\n\treturn gatewayMap[ type ];\r\n}\r\n\r\n/**\r\n * Register a gateway for a given preview type.\r\n *\r\n * @param {string} type preview type\r\n * @param {Gateway} gateway\r\n */\r\nexport function registerGatewayForPreviewType( type, gateway ) {\r\n\tgatewayMap[ type ] = gateway;\r\n}\r\n","import { createModel } from '../preview/model';\r\nimport * as formatter from '../formatter';\r\nimport { abortablePromise } from './index.js';\r\n\r\n/**\r\n * @module gateway/mediawiki\r\n * @private\r\n * @ignore\r\n */\r\n\r\n// Public and private cache lifetime (5 minutes)\r\n//\r\n// FIXME: Move this to src/constants.js.\r\nconst CACHE_LIFETIME = 300;\r\n\r\n/**\r\n * @typedef {Gateway} MediaWikiGateway\r\n * @property {function(Object): Object} extractPageFromResponse\r\n * @property {function(Object): Object} formatPlainTextExtract\r\n */\r\n\r\n/**\r\n * Creates an instance of the MediaWiki API gateway.\r\n *\r\n * @ignore\r\n * @param {mw.Api} api\r\n * @param {Object} config Configuration that affects the major behavior of the\r\n *  gateway.\r\n * @param {number} config.THUMBNAIL_SIZE The length of the major dimension of\r\n *  the thumbnail.\r\n * @param {number} config.EXTRACT_LENGTH The maximum length, in characters,\r\n *  of the extract.\r\n * @param {string} config.acceptLanguage The accepted language sent in the\r\n *  header\r\n * @return {MediaWikiGateway}\r\n */\r\nexport default function createMediaWikiApiGateway( api, config ) {\r\n\tfunction fetch( title ) {\r\n\t\treturn api.get( {\r\n\t\t\taction: 'query',\r\n\t\t\tprop: 'info|extracts|pageimages|revisions|info',\r\n\t\t\tformatversion: 2,\r\n\t\t\tredirects: true,\r\n\t\t\texintro: mw.config.get( 'wgPopupsTextExtractsIntroOnly', true ),\r\n\t\t\texchars: config.EXTRACT_LENGTH,\r\n\r\n\t\t\t// There is an added geometric limit on .mwe-popups-extract\r\n\t\t\t// so that text does not overflow from the card.\r\n\t\t\texplaintext: true,\r\n\t\t\texsectionformat: 'plain',\r\n\r\n\t\t\tpiprop: 'thumbnail',\r\n\t\t\tpithumbsize: config.THUMBNAIL_SIZE,\r\n\t\t\tpilicense: 'any',\r\n\t\t\trvprop: 'timestamp',\r\n\t\t\tinprop: 'url',\r\n\t\t\ttitles: title,\r\n\t\t\tsmaxage: CACHE_LIFETIME,\r\n\t\t\tmaxage: CACHE_LIFETIME,\r\n\t\t\tuselang: 'content'\r\n\t\t}, {\r\n\t\t\theaders: {\r\n\t\t\t\t'X-Analytics': 'preview=1',\r\n\t\t\t\t'Accept-Language': config.acceptLanguage\r\n\t\t\t}\r\n\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * @param {mw.Title} title\r\n\t * @return {AbortPromise<PagePreviewModel>}\r\n\t */\r\n\tfunction fetchPreviewForTitle( title ) {\r\n\t\tconst xhr = fetch( title.getPrefixedDb() );\r\n\t\treturn abortablePromise( xhr.then( ( data ) => {\r\n\t\t\tconst page = extractPageFromResponse( data );\r\n\t\t\tconst plainTextExtract = formatPlainTextExtract( page );\r\n\t\t\treturn convertPageToModel( plainTextExtract );\r\n\t\t} ), () => xhr.abort() );\r\n\t}\r\n\r\n\treturn {\r\n\t\tfetch,\r\n\t\textractPageFromResponse,\r\n\t\tconvertPageToModel,\r\n\t\tfetchPreviewForTitle,\r\n\t\tformatPlainTextExtract\r\n\t};\r\n}\r\n\r\n/**\r\n * Extracts page data from the API response.\r\n *\r\n * @method\r\n * @name MediaWikiGateway#extractPageFromResponse\r\n * @param {Object} data The response\r\n * @throws {Error} If the response is empty or doesn't contain data about the\r\n *  page\r\n * @return {Object}\r\n */\r\nfunction extractPageFromResponse( data ) {\r\n\tif (\r\n\t\tdata.query &&\r\n\t\tdata.query.pages &&\r\n\t\tdata.query.pages.length\r\n\t) {\r\n\t\treturn data.query.pages[ 0 ];\r\n\t}\r\n\r\n\tthrow new Error( 'API response `query.pages` is empty.' );\r\n}\r\n\r\n/**\r\n * Make plain text nicer by applying formatter.\r\n *\r\n * @method\r\n * @name MediaWikiGateway#formatPlainTextExtract\r\n * @param {Object} data The response\r\n * @return {Object}\r\n */\r\nfunction formatPlainTextExtract( data ) {\r\n\tconst result = Object.assign( {}, data );\r\n\tresult.extract = formatter.formatPlainTextExtract( data.extract, data.title );\r\n\treturn result;\r\n}\r\n\r\n/**\r\n * Converts the API response to a preview model.\r\n *\r\n * @method\r\n * @name MediaWikiGateway#convertPageToModel\r\n * @param {Object} page\r\n * @return {PagePreviewModel}\r\n */\r\nfunction convertPageToModel( page ) {\r\n\treturn createModel(\r\n\t\tpage.title,\r\n\t\tpage.canonicalurl,\r\n\t\tpage.pagelanguagehtmlcode,\r\n\t\tpage.pagelanguagedir,\r\n\t\tpage.extract,\r\n\t\tpage.type,\r\n\t\tpage.thumbnail,\r\n\t\tpage.pageid\r\n\t);\r\n}\r\n","import { createModel } from '../preview/model';\r\nimport { abortablePromise } from './index.js';\r\n/**\r\n * @module gateway/rest\r\n * @private\r\n */\r\nconst RESTBASE_PROFILE = 'https://www.mediawiki.org/wiki/Specs/Summary/1.2.0';\r\n\r\n/** @typedef {function(JQuery.AjaxSettings=): JQuery.jqXHR} Ajax */\r\n\r\n/**\r\n * Creates an instance of the RESTBase gateway.\r\n *\r\n * This gateway differs from the {@link MediaWikiGateway MediaWiki gateway} in\r\n * that it fetches page data from [the RESTBase page summary endpoint][0].\r\n *\r\n * [0]: https://en.wikipedia.org/api/rest_v1/#!/Page_content/get_page_summary_title\r\n *\r\n * @private\r\n * @ignore\r\n * @param {Ajax} ajax A function with the same signature as `jQuery.ajax`\r\n * @param {Object} config Configuration that affects the major behavior of the\r\n *  gateway.\r\n * @param {Function} extractParser A function that takes response and returns\r\n *  parsed extract\r\n * @return {Gateway}\r\n */\r\nexport default function createRESTBaseGateway( ajax, config, extractParser ) {\r\n\t/**\r\n\t * Fetches page data from [the RESTBase page summary endpoint][0].\r\n\t *\r\n\t * [0]: https://en.wikipedia.org/api/rest_v1/#!/Page_content/get_page_summary_title\r\n\t *\r\n\t * @method\r\n\t * @name RESTBaseGateway#fetch\r\n\t * @param {string} title\r\n\t * @return {jQuery.jqXHR}\r\n\t */\r\n\tfunction fetch( title ) {\r\n\t\tconst endpoint = config.endpoint;\r\n\r\n\t\treturn ajax( {\r\n\t\t\turl: endpoint + encodeURIComponent( title ),\r\n\t\t\theaders: {\r\n\t\t\t\tAccept: `application/json; charset=utf-8; profile=\"${ RESTBASE_PROFILE }\"`,\r\n\t\t\t\t'Accept-Language': config.acceptLanguage\r\n\t\t\t}\r\n\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * @param {mw.Title} title\r\n\t * @return {AbortPromise<PagePreviewModel>}\r\n\t */\r\n\tfunction fetchPreviewForTitle( title ) {\r\n\t\tconst titleText = title.getPrefixedDb(),\r\n\t\t\txhr = fetch( titleText );\r\n\t\treturn abortablePromise( xhr.then( ( page ) => {\r\n\t\t\t// Endpoint response may be empty or simply missing a title.\r\n\t\t\tpage = page || {};\r\n\t\t\tpage.title = page.title || titleText;\r\n\t\t\t// And extract may be omitted if empty string\r\n\t\t\tpage.extract = page.extract || '';\r\n\t\t\treturn convertPageToModel(\r\n\t\t\t\tpage, config.THUMBNAIL_SIZE, extractParser\r\n\t\t\t);\r\n\t\t} ).catch( ( jqXHR, textStatus, errorThrown ) => {\r\n\t\t\t// The client will choose how to handle these errors which may include\r\n\t\t\t// those due to HTTP 4xx and 5xx status. The rejection typing matches\r\n\t\t\t// fetch failures.\r\n\t\t\treturn Promise.reject( 'http', {\r\n\t\t\t\txhr: jqXHR,\r\n\t\t\t\ttextStatus,\r\n\t\t\t\texception: errorThrown\r\n\t\t\t} );\r\n\t\t} ), () => xhr.abort() );\r\n\t}\r\n\r\n\treturn {\r\n\t\tfetch,\r\n\t\tconvertPageToModel,\r\n\t\tfetchPreviewForTitle\r\n\t};\r\n}\r\n\r\n/**\r\n * Checks whether the `originalImage` property contains an image\r\n * format that's safe to render.\r\n * https://www.mediawiki.org/wiki/Help:Images#Supported_media_types_for_images\r\n *\r\n * @param {string} filename\r\n * @ignore\r\n * @return {boolean}\r\n */\r\nfunction isSafeImgFormat( filename ) {\r\n\tconst safeImage = new RegExp( /\\.(jpg|jpeg|png|gif)$/i );\r\n\treturn safeImage.test( filename );\r\n}\r\n\r\n/**\r\n * Resizes the thumbnail to the requested width, preserving its aspect ratio.\r\n *\r\n * The requested width is limited to that of the original image unless the image\r\n * is an SVG, which can be scaled infinitely.\r\n *\r\n * This function is only intended to mangle the pretty thumbnail URLs used on\r\n * Wikimedia Commons. Once [an official thumb API](https://phabricator.wikimedia.org/T66214)\r\n * is fully specified and implemented, this function can be made more general.\r\n *\r\n * @param {Object} thumbnail The thumbnail image\r\n * @param {Object} original The original image\r\n * @param {number} thumbSize The requested size\r\n * @return {{source: string, width: number, height: number}|undefined}\r\n */\r\nfunction generateThumbnailData( thumbnail, original, thumbSize ) {\r\n\tconst parts = thumbnail.source.split( '/' ),\r\n\t\tlastPart = parts[ parts.length - 1 ],\r\n\t\toriginalIsSafe = isSafeImgFormat( original.source ) || undefined;\r\n\r\n\t// The last part, the thumbnail's full filename, is in the following form:\r\n\t// ${width}px-${filename}.${extension}. Splitting the thumbnail's filename\r\n\t// makes this function resilient to the thumbnail not having the same\r\n\t// extension as the original image, which is definitely the case for SVG's\r\n\t// where the thumbnail's extension is .svg.png.\r\n\tconst filenamePxIndex = lastPart.indexOf( 'px-' );\r\n\tif ( filenamePxIndex === -1 ) {\r\n\t\t// The thumbnail size is not customizable. Presumably, RESTBase requested a\r\n\t\t// width greater than the original and so MediaWiki returned the original's\r\n\t\t// URL instead of a thumbnail compatible URL. An original URL does not have\r\n\t\t// a \"thumb\" path, e.g.:\r\n\t\t//\r\n\t\t//   https://upload.wikimedia.org/wikipedia/commons/a/aa/Red_Giant_Earth_warm.jpg\r\n\t\t//\r\n\t\t// Instead of:\r\n\t\t//\r\n\t\t//   https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Red_Giant_Earth_warm.jpg/512px-Red_Giant_Earth_warm.jpg\r\n\t\t//\r\n\t\t// Use the original if it's a supported image format.\r\n\t\treturn originalIsSafe && original;\r\n\t}\r\n\tconst filename = lastPart.slice( filenamePxIndex + 3 );\r\n\r\n\t// Scale the thumbnail's largest dimension.\r\n\tlet width, height;\r\n\tif ( thumbnail.width > thumbnail.height ) {\r\n\t\twidth = thumbSize;\r\n\t\theight = Math.floor( ( thumbSize / thumbnail.width ) * thumbnail.height );\r\n\t} else {\r\n\t\twidth = Math.floor( ( thumbSize / thumbnail.height ) * thumbnail.width );\r\n\t\theight = thumbSize;\r\n\t}\r\n\r\n\t// If the image isn't an SVG, then it shouldn't be scaled past its original\r\n\t// dimensions.\r\n\tif ( width >= original.width && filename.indexOf( '.svg' ) === -1 ) {\r\n\t\t// if the image format is not supported, it shouldn't be rendered.\r\n\t\treturn originalIsSafe && original;\r\n\t}\r\n\r\n\tparts[ parts.length - 1 ] = `${ width }px-${ filename }`;\r\n\r\n\treturn {\r\n\t\tsource: parts.join( '/' ),\r\n\t\twidth,\r\n\t\theight\r\n\t};\r\n}\r\n\r\n/**\r\n * Converts the API response to a preview model.\r\n *\r\n * @method\r\n * @ignore\r\n * @name RESTBaseGateway#convertPageToModel\r\n * @param {Object} page\r\n * @param {number} thumbSize\r\n * @param {Function} extractParser\r\n * @return {PagePreviewModel}\r\n */\r\nexport function convertPageToModel( page, thumbSize, extractParser ) {\r\n\treturn createModel(\r\n\t\tpage.title,\r\n\t\tnew mw.Title( page.title ).getUrl(),\r\n\t\tpage.lang,\r\n\t\tpage.dir,\r\n\t\textractParser( page ),\r\n\t\tpage.type,\r\n\t\tpage.thumbnail ?\r\n\t\t\tgenerateThumbnailData(\r\n\t\t\t\tpage.thumbnail, page.originalimage, thumbSize\r\n\t\t\t) : undefined,\r\n\t\tpage.pageid\r\n\t);\r\n}\r\n","/**\r\n * @module restFormatters\r\n * @private\r\n */\r\n\r\nimport * as formatter from '../formatter';\r\n\r\n/**\r\n * Prepare extract\r\n *\r\n * @param {Object} page Rest response\r\n * @return {Array} An array of DOM Elements\r\n */\r\nexport function parseHTMLResponse( page ) {\r\n\tconst extract = page.extract_html;\r\n\tconst extractNode = document.createElement( 'div' );\r\n\textractNode.innerHTML = extract;\r\n\treturn extract.length === 0 ? [] : extractNode.childNodes;\r\n}\r\n\r\n/**\r\n * Prepare extract\r\n *\r\n * @param {Object} page Rest response\r\n * @return {Array} An array of DOM Elements\r\n */\r\nexport function parsePlainTextResponse( page ) {\r\n\treturn formatter.formatPlainTextExtract( page.extract, page.title );\r\n}\r\n","import constants from '../constants';\nimport createMediaWikiApiGateway from './mediawiki';\nimport createRESTBaseGateway from './rest';\nimport createRestOpenSearchGateWay from './restWithSearch';\nimport * as formatters from './restFormatters';\nimport { abortablePromise } from './index.js';\n\n/**\n * @module gateway/page\n * @private\n */\n/**\n * @param {Object} options\n * @return {Promise}\n */\nfunction ajax( options ) {\n\tconst controller = new AbortController();\n\tconst signal = controller.signal;\n\n\treturn abortablePromise(\n\t\tfetch( options.url, {\n\t\t\theaders: options.headers,\n\t\t\tsignal\n\t\t} ).then( ( resp ) => resp.json() ),\n\t\t() => {\n\t\t\tcontroller.abort();\n\t\t}\n\t);\n}\n\n/**\n * Creates a page preview gateway with sensible values for the dependencies.\n *\n * @param {mw.Map} config\n * @return {Gateway}\n */\nexport default function createPagePreviewGateway( config ) {\n\tconst gatewayConfig = Object.assign( {}, constants, {\n\t\tacceptLanguage: config.get( 'wgPageContentLanguage' )\n\t} );\n\tconst restConfig = Object.assign( {}, gatewayConfig, {\n\t\tendpoint: config.get( 'wgPopupsRestGatewayEndpoint' )\n\t} );\n\tswitch ( config.get( 'wgPopupsGateway' ) ) {\n\t\tcase 'mwApiPlain':\n\t\t\treturn createMediaWikiApiGateway( new mw.Api(), gatewayConfig );\n\t\tcase 'restbasePlain':\n\t\t\treturn createRESTBaseGateway(\n\t\t\t\tajax, restConfig, formatters.parsePlainTextResponse );\n\t\tcase 'restbaseWithSearch':\n\t\t\treturn createRestOpenSearchGateWay(\n\t\t\t\tajax,\n\t\t\t\trestConfig,\n\t\t\t\tformatters.parsePlainTextResponse,\n\t\t\t\tnew mw.ForeignApi(\n\t\t\t\t\t'//en.wikipedia.org/w/api.php',\n\t\t\t\t\t{ anonymous: true }\n\t\t\t\t)\n\t\t\t);\n\t\tcase 'restbaseHTML':\n\t\t\treturn createRESTBaseGateway(\n\t\t\t\tajax, restConfig, formatters.parseHTMLResponse );\n\t\tdefault:\n\t\t\tthrow new Error( 'Unknown gateway' );\n\t}\n}\n","import { previewTypes } from './preview/model';\r\n\r\n/**\r\n * @module userSettings\r\n * @private\r\n */\r\n\r\nconst PAGE_PREVIEWS_ENABLED_KEY = 'mwe-popups-enabled',\r\n\tREFERENCE_PREVIEWS_ENABLED_KEY = 'mwe-popups-referencePreviews-enabled',\r\n\tPAGE_PREVIEWS_CHANGE_SETTING_EVENT = 'Popups.SettingChange';\r\n\r\n/**\r\n * Creates an object whose methods encapsulate all interactions with the UA's\r\n * storage.\r\n *\r\n * @param {mw.storage} storage The `mw.storage` singleton instance\r\n *\r\n * @return {UserSettings}\r\n */\r\nexport default function createUserSettings( storage ) {\r\n\treturn {\r\n\t\tmigrateOldPreferences() {\r\n\t\t\tconst isDisabled = !!storage.get( PAGE_PREVIEWS_ENABLED_KEY );\r\n\t\t\tif ( isDisabled ) {\r\n\t\t\t\tstorage.remove( PAGE_PREVIEWS_ENABLED_KEY );\r\n\t\t\t\tthis.storePreviewTypeEnabled( previewTypes.TYPE_PAGE, false );\r\n\t\t\t}\r\n\t\t\tconst TYPE_REFERENCE = 'reference';\r\n\t\t\tconst isRefsDisabled = !!storage.get( REFERENCE_PREVIEWS_ENABLED_KEY );\r\n\t\t\tif ( isRefsDisabled ) {\r\n\t\t\t\tstorage.remove( REFERENCE_PREVIEWS_ENABLED_KEY );\r\n\t\t\t\tthis.storePreviewTypeEnabled( TYPE_REFERENCE, false );\r\n\t\t\t}\r\n\t\t},\r\n\t\t/**\r\n\t\t * Check whether the preview type is enabled.\r\n\t\t *\r\n\t\t * @method\r\n\t\t * @param {string} previewType\r\n\t\t *\r\n\t\t * @return {boolean}\r\n\t\t */\r\n\t\tisPreviewTypeEnabled( previewType ) {\r\n\t\t\tconst storageKey = `mwe-popups-${ previewType }-enabled`;\r\n\t\t\tconst value = storage.get( storageKey );\r\n\t\t\treturn value === null;\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Permanently persists (typically in localStorage) whether the user has enabled\r\n\t\t * the preview type.\r\n\t\t *\r\n\t\t * @method\r\n\t\t * @name UserSettings#storePreviewTypeEnabled\r\n\t\t * @param {string} previewType\r\n\t\t * @param {boolean} enabled\r\n\t\t */\r\n\t\tstorePreviewTypeEnabled( previewType, enabled ) {\r\n\t\t\tconst storageKey = `mwe-popups-${ previewType }-enabled`;\r\n\t\t\tif ( enabled ) {\r\n\t\t\t\tstorage.remove( storageKey );\r\n\t\t\t} else {\r\n\t\t\t\tstorage.set( storageKey, '0' );\r\n\t\t\t}\r\n\t\t\t/**\r\n\t\t\t * @stable for use in MediaWiki extensions.\r\n\t\t\t */\r\n\t\t\tmw.track( PAGE_PREVIEWS_CHANGE_SETTING_EVENT, {\r\n\t\t\t\tpreviewType,\r\n\t\t\t\taction: enabled ? 'anonymousEnabled' : 'anonymousDisabled'\r\n\t\t\t} );\r\n\t\t}\r\n\t};\r\n}\r\n","/**\r\n * @module previewBehaviour\r\n * @private\r\n */\r\nconst canSaveToUserPreferences = require( './canSaveToUserPreferences.js' );\r\n\r\n/**\r\n * A collection of event handlers specific to how the user interacts with all\r\n * previews. The event handlers  are are agnostic to how/when they are bound\r\n * //but not to what they are bound//, i.e. the showSettings event handler is\r\n * written to be bound to either an `<a>` or `<button>` element.\r\n *\r\n * @typedef {Object} ext.popups.PreviewBehavior\r\n * @property {string} settingsUrl\r\n * @property {Function} showSettings\r\n * @property {Function} previewDwell\r\n * @property {Function} previewAbandon\r\n * @property {Function} previewShow\r\n * @property {Function} click handler for the entire preview\r\n */\r\n\r\n/**\r\n * Creates an instance of `ext.popups.PreviewBehavior`.\r\n *\r\n * If the user is logged out, then clicking the cog should show the settings\r\n * modal.\r\n *\r\n * If the user is logged in, then clicking the cog should send them to the\r\n * the \"Appearance\" tab otherwise.\r\n *\r\n * @param {mw.User} user\r\n * @param {Object} actions The action creators bound to the Redux store\r\n * @return {ext.popups.PreviewBehavior}\r\n */\r\nexport default function createPreviewBehavior( user, actions ) {\r\n\tlet settingsUrl, showSettings = () => {};\r\n\r\n\tif ( !canSaveToUserPreferences( user ) ) {\r\n\t\tshowSettings = ( event ) => {\r\n\t\t\tevent.preventDefault();\r\n\r\n\t\t\tactions.showSettings();\r\n\t\t};\r\n\t} else {\r\n\t\tconst rawTitle = 'Special:Preferences#mw-prefsection-rendering';\r\n\r\n\t\tsettingsUrl = mw.Title.newFromText( rawTitle )\r\n\t\t\t.getUrl();\r\n\t}\r\n\r\n\treturn {\r\n\t\tsettingsUrl,\r\n\t\tshowSettings,\r\n\t\tpreviewDwell: actions.previewDwell,\r\n\t\tpreviewAbandon: actions.abandon,\r\n\t\tpreviewShow: actions.previewShow,\r\n\t\tclick: actions.linkClick\r\n\t};\r\n}\r\n","import { createSettingsDialog } from './settingsDialog';\r\n\r\nconst initDialog = ( boundActions, previewTypesEnabled ) => {\r\n\tconst dialog = createSettingsDialog( previewTypesEnabled );\r\n\r\n\t// Setup event bindings\r\n\tdialog.querySelector( '.save' ).addEventListener( 'click', () => {\r\n\t\tboundActions.saveSettings(\r\n\t\t\tArray.from( dialog.querySelectorAll( 'input' ) ).reduce(\r\n\t\t\t\t( enabled, el ) => {\r\n\t\t\t\t\tenabled[ el.value ] = el.matches( ':checked' );\r\n\t\t\t\t\treturn enabled;\r\n\t\t\t\t},\r\n\t\t\t\t{}\r\n\t\t\t)\r\n\t\t);\r\n\t} );\r\n\r\n\tdialog.querySelector( '.okay' ).addEventListener( 'click', boundActions.hideSettings );\r\n\tdialog.querySelector( '.close' ).addEventListener( 'click', boundActions.hideSettings );\r\n\treturn dialog;\r\n};\r\n/**\r\n * @module settingsDialogRenderer\r\n * @private\r\n */\r\n/**\r\n * Creates a render function that will create the settings dialog and return\r\n * a set of methods to operate on it\r\n *\r\n * @private\r\n * @ignore\r\n * @return {Function} render function\r\n */\r\nexport default function createSettingsDialogRenderer() {\r\n\t/**\r\n\t * Cached settings dialog\r\n\t *\r\n\t * @type {HTMLElement}\r\n\t */\r\n\tlet dialog,\r\n\t\t/**\r\n\t\t * Cached settings overlay\r\n\t\t *\r\n\t\t * @type {HTMLElement}\r\n\t\t */\r\n\t\toverlay;\r\n\r\n\t/**\r\n\t * Renders the relevant form and labels in the settings dialog\r\n\t *\r\n\t * @param {Object} boundActions\r\n\t * @param {Object} previewTypesEnabled\r\n\t * @return {Object} object with methods to affect the rendered UI\r\n\t */\r\n\treturn ( boundActions, previewTypesEnabled ) => {\r\n\t\tif ( !dialog ) {\r\n\t\t\toverlay = document.createElement( 'div' );\r\n\t\t\toverlay.classList.add( 'mwe-popups-overlay' );\r\n\t\t\tdialog = initDialog( boundActions, previewTypesEnabled );\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\t/**\r\n\t\t\t * Re-initialize the dialog when the available settings have changed.\r\n\t\t\t *\r\n\t\t\t * @param {Object} previewTypesEnabledNew updated key value pairs\r\n\t\t\t */\r\n\t\t\trefresh( previewTypesEnabledNew ) {\r\n\t\t\t\tconst parent = dialog.parentNode;\r\n\t\t\t\tdialog.remove();\r\n\t\t\t\tdialog = initDialog( boundActions, previewTypesEnabledNew );\r\n\t\t\t\tif ( parent ) {\r\n\t\t\t\t\tdialog.appendTo( parent );\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t/**\r\n\t\t\t * Append the dialog and overlay to a DOM element\r\n\t\t\t *\r\n\t\t\t * @param {HTMLElement} el\r\n\t\t\t */\r\n\t\t\tappendTo( el ) {\r\n\t\t\t\tel.appendChild( overlay );\r\n\t\t\t\toverlay.appendChild( dialog );\r\n\t\t\t},\r\n\r\n\t\t\t/**\r\n\t\t\t * Show the settings element and position it correctly\r\n\t\t\t */\r\n\t\t\tshow() {\r\n\t\t\t\t// Load additional styles for checkboxes\r\n\t\t\t\tmw.loader.using( 'codex-styles' ).then( () => {\r\n\t\t\t\t\t// RequestIdleCallback must be called to make sure\r\n\t\t\t\t\t// the new stylesheet has been applied.\r\n\t\t\t\t\tmw.requestIdleCallback( () => {\r\n\t\t\t\t\t\toverlay.style.display = '';\r\n\t\t\t\t\t} );\r\n\t\t\t\t} );\r\n\t\t\t},\r\n\r\n\t\t\t/**\r\n\t\t\t * Hide the settings dialog.\r\n\t\t\t */\r\n\t\t\thide() {\r\n\t\t\t\toverlay.style.display = 'none';\r\n\t\t\t},\r\n\r\n\t\t\t/**\r\n\t\t\t * Toggle the help dialog on or off\r\n\t\t\t *\r\n\t\t\t * @param {boolean} visible if you want to show or hide the help dialog\r\n\t\t\t */\r\n\t\t\ttoggleHelp( visible ) {\r\n\t\t\t\ttoggleHelp( dialog, visible );\r\n\t\t\t},\r\n\r\n\t\t\t/**\r\n\t\t\t * Update the form depending on the enabled flag\r\n\t\t\t *\r\n\t\t\t * @param {Object} enabled Mapping preview type identifiers to boolean flags\r\n\t\t\t */\r\n\t\t\tsetEnabled( enabled ) {\r\n\t\t\t\tObject.keys( enabled ).forEach( ( type ) => {\r\n\t\t\t\t\tconst node = dialog.querySelector( `#mwe-popups-settings-${ type }` );\r\n\t\t\t\t\tif ( node ) {\r\n\t\t\t\t\t\tnode.checked = enabled[ type ];\r\n\t\t\t\t\t}\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t};\r\n\t};\r\n}\r\n\r\n/**\r\n * @param {NodeList} nodes\r\n */\r\nfunction hideAll( nodes ) {\r\n\tArray.prototype.forEach.call( nodes, ( node ) => {\r\n\t\tnode.style.display = 'none';\r\n\t} );\r\n}\r\n\r\n/**\r\n * @param {NodeList} nodes\r\n */\r\nfunction showAll( nodes ) {\r\n\tArray.prototype.forEach.call( nodes, ( node ) => {\r\n\t\tnode.style.display = '';\r\n\t} );\r\n}\r\n\r\n/**\r\n * Toggles the visibility between a form and the help\r\n *\r\n * @param {HTMLElement} dialog element that contains form and help\r\n * @param {boolean} visible if the help should be visible, or the form\r\n */\r\nexport function toggleHelp( dialog, visible ) {\r\n\tconst\r\n\t\tformSelectors = 'main, .save, .close',\r\n\t\thelpSelectors = '.mwe-popups-settings-help, .okay';\r\n\r\n\tif ( visible ) {\r\n\t\thideAll( dialog.querySelectorAll( formSelectors ) );\r\n\t\tshowAll( dialog.querySelectorAll( helpSelectors ) );\r\n\t} else {\r\n\t\tshowAll( dialog.querySelectorAll( formSelectors ) );\r\n\t\thideAll( dialog.querySelectorAll( helpSelectors ) );\r\n\t}\r\n}\r\n","/**\r\n * @module settingsDialog\r\n * @private\r\n */\r\n\r\nimport { renderSettingsDialog } from './templates/settingsDialog/settingsDialog';\r\n\r\n/**\r\n * Create the settings dialog shown to anonymous users.\r\n *\r\n * @param {Object} previewTypesEnabled\r\n * @return {HTMLElement} settings dialog\r\n */\r\nexport function createSettingsDialog( previewTypesEnabled ) {\r\n\tconst choices = Object.keys( previewTypesEnabled ).map( ( id ) => (\r\n\t\t{\r\n\t\t\tid,\r\n\t\t\t// This can produce:\r\n\t\t\t// * popups-settings-option-preview\r\n\t\t\t// * popups-settings-option-reference\r\n\t\t\tname: mw.msg( `popups-settings-option-${ id }` ),\r\n\t\t\t// This can produce:\r\n\t\t\t// * popups-settings-option-preview-description\r\n\t\t\t// * popups-settings-option-reference-description\r\n\t\t\tdescription: mw.msg( `popups-settings-option-${ id }-description` ),\r\n\t\t\tisChecked: previewTypesEnabled[ id ]\r\n\t\t}\r\n\t) );\r\n\r\n\treturn renderSettingsDialog( {\r\n\t\theading: mw.msg( 'popups-settings-title' ),\r\n\t\tcloseLabel: mw.msg( 'popups-settings-cancel' ),\r\n\t\tsaveLabel: mw.msg( 'popups-settings-save' ),\r\n\t\thelpText: mw.msg( 'popups-settings-help' ),\r\n\t\tokLabel: mw.msg( 'popups-settings-help-ok' ),\r\n\t\tchoices\r\n\t} );\r\n}\r\n","/**\r\n * @module settingsDialog\r\n * @private\r\n */\r\n\r\nimport { escapeHTML } from '../templateUtil';\r\n\r\n/**\r\n * @typedef {Object} SettingsModel\r\n * @property {string} heading\r\n * @property {string} closeLabel\r\n * @property {string} saveLabel\r\n * @property {string} helpText\r\n * @property {string} okLabel\r\n * @property {SettingsChoiceModel[]} [choices]\r\n */\r\n\r\n/**\r\n * @typedef {Object} SettingsChoiceModel\r\n * @property {string} id Portion of the elements' IDs and value of the input.\r\n * @property {string} name\r\n * @property {string} [description]\r\n * @property {boolean} [isChecked] Whether the setting is checked.\r\n */\r\n\r\n/**\r\n * @param {SettingsChoiceModel[]} [choices]\r\n * @return {SettingsChoiceModel}\r\n */\r\nfunction escapeChoices( choices = [] ) {\r\n\treturn choices.map(\r\n\t\t( { id, name, description, isChecked } ) =>\r\n\t\t\t( {\r\n\t\t\t\tid: escapeHTML( id ),\r\n\t\t\t\tname: escapeHTML( name ),\r\n\t\t\t\tdescription: description ? escapeHTML( description ) : '',\r\n\t\t\t\tisChecked\r\n\t\t\t} )\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {SettingsModel} model\r\n * @return {HTMLElement}\r\n */\r\nexport function renderSettingsDialog( model ) {\r\n\tconst heading = escapeHTML( model.heading ),\r\n\t\tsaveLabel = escapeHTML( model.saveLabel ),\r\n\t\tcloseLabel = escapeHTML( model.closeLabel ),\r\n\t\thelpText = escapeHTML( model.helpText ),\r\n\t\tokLabel = escapeHTML( model.okLabel ),\r\n\t\tchoices = escapeChoices( model.choices );\r\n\tconst node = document.createElement( 'div' );\r\n\tnode.innerHTML = `\r\n\t\t<section id='mwe-popups-settings'>\r\n\t\t\t<header>\r\n\t\t\t\t<div>\r\n\t\t\t\t\t<button class='cdx-button cdx-button--weight-quiet cdx-button--icon-only'>\r\n\t\t\t\t\t\t<span class='popups-icon popups-icon--close close'></span>\r\n\t\t\t\t\t\t<span>${ closeLabel }</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t\t<h1>${ heading }</h1>\r\n\t\t\t\t<div>\r\n\t\t\t\t\t<button class='save cdx-button cdx-button--weight-primary cdx-button--action-progressive'>${ saveLabel }</button>\r\n\t\t\t\t\t<button class='okay cdx-button cdx-button--weight-primary cdx-button--action-progressive' style='display:none;'>${ okLabel }</button>\r\n\t\t\t\t</div>\r\n\t\t\t</header>\r\n\t\t\t<main id='mwe-popups-settings-form'>\r\n\t\t\t\t<form>\r\n\t\t\t\t\t${ choices.map( ( { id, name, description, isChecked } ) => `\r\n\t\t\t\t\t<p class=\"cdx-checkbox\">\r\n\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t${ isChecked ? 'checked' : '' }\r\n\t\t\t\t\t\t\tvalue='${ id }'\r\n\t\t\t\t\t\t\ttype='checkbox'\r\n\t\t\t\t\t\t\tid='mwe-popups-settings-${ id }'\r\n\t\t\t\t\t\t\tclass='cdx-checkbox__input'>\r\n\t\t\t\t\t\t<span class=\"cdx-checkbox__icon\">&nbsp;</span>\r\n\t\t\t\t\t\t<label class=\"cdx-checkbox__label\" for='mwe-popups-settings-${ id }'>\r\n\t\t\t\t\t\t\t<span>${ name }</span>\r\n\t\t\t\t\t\t\t${ description }\r\n\t\t\t\t\t\t</label>\r\n\t\t\t\t\t</p>` ).join( '' ) }\r\n\t\t\t\t</form>\r\n\t\t\t</main>\r\n\t\t\t<div class='mwe-popups-settings-help' style='display:none;'>\r\n\t\t\t\t<div class=\"popups-icon popups-icon--footer\"></div>\r\n\t\t\t\t<p>${ helpText }</p>\r\n\t\t\t</div>\r\n\t\t</section>\r\n\t`.trim();\r\n\treturn node.querySelector( 'section' );\r\n}\r\n","/**\r\n * @module changeListener\r\n * @private\r\n */\r\n\r\n/**\r\n * @typedef {Function} ext.popups.ChangeListener\r\n * @param {Object} oldState The previous state\r\n * @param {Object} newState The current state\r\n */\r\n\r\n/**\r\n * Registers a change listener, which is bound to the\r\n * [store](http://redux.js.org/docs/api/Store.html).\r\n *\r\n * A change listener is a function that is only invoked when the state in the\r\n * [store](http://redux.js.org/docs/api/Store.html) changes. N.B. that there\r\n * may not be a 1:1 correspondence with actions being dispatched to the store\r\n * and the state in the store changing.\r\n *\r\n * See [Store#subscribe](http://redux.js.org/docs/api/Store.html#subscribe)\r\n * for more information about what change listeners may and may not do.\r\n *\r\n * @param {Redux.Store} store\r\n * @param {ext.popups.ChangeListener} callback\r\n */\r\nexport default function registerChangeListener( store, callback ) {\r\n\t// This function is based on the example in [the documentation for\r\n\t// Store#subscribe](http://redux.js.org/docs/api/Store.html#subscribe),\r\n\t// which was written by Dan Abramov.\r\n\r\n\tlet previousState;\r\n\r\n\tstore.subscribe( () => {\r\n\t\tconst state = store.getState();\r\n\r\n\t\tif ( previousState !== state ) {\r\n\t\t\tcallback( previousState, state );\r\n\t\t\tpreviousState = state;\r\n\t\t}\r\n\t} );\r\n}\r\n","/**\r\n * @module isPagePreviewsEnabled\r\n * @private\r\n */\r\nimport { previewTypes } from './preview/model';\r\nconst canSaveToUserPreferences = require( './canSaveToUserPreferences.js' );\r\n\r\n/**\r\n * Given the global state of the application, creates a function that gets\r\n * whether or not the user should have Page Previews enabled.\r\n *\r\n * Page Previews is disabled when the Navigation Popups gadget is enabled.\r\n *\r\n * If Page Previews is configured as a user preference, then the user must\r\n * either be logged in and have enabled the preference or be logged out and have\r\n * not disabled previews via the settings modal.\r\n *\r\n * @param {mw.User} user The `mw.user` singleton instance\r\n * @param {Object} userSettings An object returned by `userSettings.js`\r\n * @param {mw.Map} config\r\n *\r\n * @return {boolean|null} Null when there is no way the popup type can be enabled at run-time.\r\n */\r\nexport default function isPagePreviewsEnabled( user, userSettings, config ) {\r\n\t// T160081: Unavailable when in conflict with the Navigation Popups gadgets.\r\n\tif ( config.get( 'wgPopupsConflictsWithNavPopupGadget' ) ) {\r\n\t\treturn null;\r\n\t}\r\n\r\n\t// For anonymous users, and for IP masked usersm the code loads always,\r\n\t// but the feature can be toggled at run-time via local storage.\r\n\tif ( !canSaveToUserPreferences( user ) ) {\r\n\t\treturn userSettings.isPreviewTypeEnabled( previewTypes.TYPE_PAGE );\r\n\t}\r\n\r\n\t// Registered users never can enable popup types at run-time.\r\n\treturn mw.user.options.get( 'popups' ) === '1' ? true : null;\r\n}\r\n","/**\r\n * @module changeListeners/syncUserSettings\r\n * @private\r\n */\r\n\r\n/**\r\n * Creates an instance of the user settings sync change listener.\r\n *\r\n * This change listener syncs certain parts of the state tree to user\r\n * settings when they change.\r\n *\r\n * Used for:\r\n *\r\n * * Enabled state: If the previews are enabled or disabled.\r\n * * Preview count: When the user dwells on a link for long enough that\r\n *   a preview is shown, then their preview count will be incremented (see\r\n *   `reducers/eventLogging.js`, and is persisted to local storage.\r\n *\r\n * @param {ext.popups.UserSettings} userSettings\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function syncUserSettings( userSettings ) {\r\n\treturn ( oldState, newState ) => {\r\n\t\tObject.keys( newState.preview.enabled ).forEach( ( key ) => {\r\n\t\t\tsyncIfChanged(\r\n\t\t\t\toldState, newState, `preview.enabled.${ key }`,\r\n\t\t\t\t( value ) => {\r\n\t\t\t\t\tuserSettings.storePreviewTypeEnabled( key, value );\r\n\t\t\t\t}\r\n\t\t\t);\r\n\t\t} );\r\n\t};\r\n}\r\n\r\n/**\r\n * Given a state tree, reducer and property, safely return the value of the\r\n * property if the reducer and property exist\r\n *\r\n * @param {Object} state tree\r\n * @param {string} path dot-separated path in the state tree\r\n * @return {any}\r\n */\r\nfunction get( state, path ) {\r\n\treturn path.split( '.' ).reduce(\r\n\t\t( element, key ) => element && element[ key ],\r\n\t\tstate\r\n\t);\r\n}\r\n\r\n/**\r\n * Calls a sync function if the property prop on the property reducer on\r\n * the state trees has changed value.\r\n *\r\n * @param {Object} oldState\r\n * @param {Object} newState\r\n * @param {string} path dot-separated path in the state tree\r\n * @param {Function} sync function to be called with the newest value if\r\n * changed\r\n */\r\nfunction syncIfChanged( oldState, newState, path, sync ) {\r\n\tconst current = get( newState, path );\r\n\tif ( oldState && ( get( oldState, path ) !== current ) ) {\r\n\t\tsync( current );\r\n\t}\r\n}\r\n","import footerLink from './footerLink';\r\nimport linkTitle from './linkTitle';\r\nimport pageviews from './pageviews';\r\nimport render from './render';\r\nimport settings from './settings';\r\nimport statsv from './statsv';\r\nimport syncUserSettings from './syncUserSettings';\r\n\r\nexport default {\r\n\tfooterLink,\r\n\tlinkTitle,\r\n\tpageviews,\r\n\trender,\r\n\tsettings,\r\n\tstatsv,\r\n\tsyncUserSettings\r\n};\r\n","/**\r\n * @module changeListeners/footerLink\r\n * @private\r\n */\r\n\r\n/**\r\n * Creates the link element and appends it to the footer element.\r\n *\r\n * The following elements are considered to be the footer element (highest\r\n * priority to lowest):\r\n *\r\n * # `#footer-places`\r\n * # `#f-list`\r\n * # The parent element of `#footer li`, which is either an `ol` or `ul`.\r\n *\r\n * @return {HTMLElement} The link element\r\n */\r\nfunction createFooterLink() {\r\n\tconst footerListItem = document.createElement( 'li' );\r\n\tconst footerLinkElement = document.createElement( 'a' );\r\n\tfooterLinkElement.href = '#';\r\n\tfooterLinkElement.textContent = mw.message( 'popups-settings-enable' ).text();\r\n\tfooterListItem.appendChild( footerLinkElement );\r\n\r\n\t// As yet, we don't know whether the link should be visible.\r\n\tfooterListItem.style.display = 'none';\r\n\r\n\t// From https://en.wikipedia.org/wiki/MediaWiki:Gadget-ReferenceTooltips.js,\r\n\t// which was written by Yair rand <https://en.wikipedia.org/wiki/User:Yair_rand>.\r\n\tlet footer = document.querySelector( '#footer-places, #f-list' );\r\n\r\n\tif ( !footer ) {\r\n\t\tconst footerLegacy = document.querySelector( '#footer li' );\r\n\t\tif ( footerLegacy ) {\r\n\t\t\tfooter = footerLegacy.parentNode;\r\n\t\t}\r\n\t}\r\n\r\n\tif ( footer ) {\r\n\t\tfooter.appendChild( footerListItem );\r\n\t}\r\n\treturn footerListItem;\r\n}\r\n\r\n/**\r\n * Creates an instance of the footer link change listener.\r\n *\r\n * The change listener covers the following behaviour:\r\n *\r\n * * The \"Edit preview settings\" link (the \"link\") is appended to the footer menu\r\n *   (see `createFooterLink` above).\r\n * * When at least one popup type is disabled, then the link is shown;\r\n *   otherwise, the link is hidden.\r\n * * When the user clicks the link, then the `showSettings` bound action\r\n *   creator is called.\r\n *\r\n * @param {Object} boundActions\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function footerLink( boundActions ) {\r\n\tlet footerLinkElement;\r\n\r\n\treturn ( oldState, newState ) => {\r\n\t\tif ( footerLinkElement === undefined ) {\r\n\t\t\tfooterLinkElement = createFooterLink();\r\n\t\t\tfooterLinkElement.addEventListener( 'click', ( e ) => {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tboundActions.showSettings();\r\n\t\t\t} );\r\n\t\t}\r\n\r\n\t\tif ( newState.settings.shouldShowFooterLink ) {\r\n\t\t\tfooterLinkElement.style.display = '';\r\n\t\t} else {\r\n\t\t\tfooterLinkElement.style.display = 'none';\r\n\t\t}\r\n\t};\r\n}\r\n","/**\n * Creates an instance of the link title change listener.\n *\n * While the user dwells on a link, then it becomes the active link. The\n * change listener will remove a link's `title` attribute while it's the\n * active link.\n *\n * @return {ext.popups.ChangeListener}\n */\nexport default function linkTitle() {\n\tlet savedTitle;\n\n\t/**\n\t * Destroys the title attribute of the element, storing its value in local\n\t * state so that it can be restored later (see `restoreTitleAttr`).\n\t *\n\t * @param {HTMLElement|undefined} el\n\t */\n\tfunction destroyTitleAttr( el ) {\n\t\t// If we already know that there is no page on the English Wikipedia,\n\t\t// no need to hide the title\n\t\tif ( el &&\n\t\t\tel.hasAttribute( 'opensearch-results' ) &&\n\t\t\tel.getAttribute( 'opensearch-results' ) === ''\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Has the user dwelled on a link? If we've already removed its title attribute, then NOOP.\n\t\tif ( el && !savedTitle ) {\n\t\t\tsavedTitle = el.getAttribute( 'title' );\n\t\t\tel.setAttribute( 'title', '' );\n\t\t}\n\t}\n\n\t/**\n\t * Restores the title attribute of the element.\n\t *\n\t * @param {HTMLElement|undefined} el\n\t */\n\tfunction restoreTitleAttr( el ) {\n\t\t// Avoid overwriting a non-empty title with an empty one, just to be sure\n\t\tif ( el && savedTitle ) {\n\t\t\tel.setAttribute( 'title', savedTitle );\n\t\t\tsavedTitle = undefined;\n\t\t}\n\t}\n\n\treturn ( oldState, newState ) => {\n\t\tconst oldLink = oldState && oldState.preview.activeLink;\n\n\t\t// Usually only one side is set when the user enters or leaves a link. Both sides contain\n\t\t// two different links when the user dwelled on a link immediately after abandoning another\n\t\t// (remembering that the ABANDON_END action is delayed by ~100 ms).\n\t\tif ( oldLink !== newState.preview.activeLink ) {\n\t\t\trestoreTitleAttr( oldLink );\n\n\t\t\t// FIXME: This will not work on anything other than 'reference' or 'preview' types as\n\t\t\t// mw.popups.register does not register the previewType as a key in\n\t\t\t// newState.preview.enabled\n\t\t\t// This is not a problem at time of writing (November 2022) but will become a problem if\n\t\t\t// we introduce custom preview types that must remove the title attribute.\n\t\t\tif ( newState.preview.enabled[ newState.preview.previewType ] ) {\n\t\t\t\tdestroyTitleAttr( newState.preview.activeLink );\n\t\t\t}\n\t\t}\n\t};\n}\n","/**\r\n * @module changeListeners/pageviews\r\n * @private\r\n */\r\n\r\n/**\r\n * Creates an instance of the pageviews change listener.\r\n *\r\n * When a pageview enqueued it'll be logged using the VirtualPageView schema.\r\n * Note, it's the responsibility of Event Logging (and the UA) to\r\n * deliver logged events.\r\n *\r\n * @param {Object} boundActions\r\n * @param {EventTracker} pageviewTracker\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function pageviews(\r\n\tboundActions, pageviewTracker\r\n) {\r\n\treturn ( oldState, newState ) => {\r\n\t\tlet page, pageview;\r\n\t\tif ( newState.pageviews && newState.pageviews.pageview && newState.pageviews.page ) {\r\n\t\t\tpage = newState.pageviews.page;\r\n\t\t\tpageview = newState.pageviews.pageview;\r\n\t\t\tpageviewTracker( 'event.VirtualPageView', {\r\n\t\t\t\t/* eslint-disable camelcase */\r\n\t\t\t\tsource_page_id: page.id,\r\n\t\t\t\tsource_namespace: page.namespaceId,\r\n\t\t\t\tsource_title: page.namespaceId === -1 ?\r\n\t\t\t\t\tmw.config.get( 'wgCanonicalSpecialPageName' ) :\r\n\t\t\t\t\tmw.Title.newFromText( page.title ).getPrefixedDb(),\r\n\t\t\t\tsource_url: page.url,\r\n\t\t\t\tpage_id: pageview.page_id,\r\n\t\t\t\tpage_namespace: pageview.page_namespace,\r\n\t\t\t\tpage_title: mw.Title.newFromText( pageview.page_title ).getPrefixedDb()\r\n\t\t\t\t/* eslint-enable camelcase */\r\n\t\t\t} );\r\n\t\t\t// Clear the pageview now its been logged.\r\n\t\t\tboundActions.pageviewLogged();\r\n\t\t}\r\n\t};\r\n}\r\n","import * as renderer from '../ui/renderer';\r\n\r\n/**\r\n * Creates an instance of the render change listener.\r\n *\r\n * FIXME: Remove hard coupling with renderer, inject it as a parameter\r\n * * Wire it up in index.js\r\n * * Fix tests to remove require mocking\r\n *\r\n * @param {ext.popups.PreviewBehavior} previewBehavior\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function render( previewBehavior ) {\r\n\tlet preview;\r\n\r\n\treturn ( oldState, newState ) => {\r\n\t\tif ( newState.preview.shouldShow && !preview ) {\r\n\t\t\tpreview = renderer.render( newState.preview.fetchResponse );\r\n\t\t\tpreview.show(\r\n\t\t\t\tnewState.preview.measures,\r\n\t\t\t\tpreviewBehavior,\r\n\t\t\t\tnewState.preview.activeToken\r\n\t\t\t);\r\n\t\t} else if ( !newState.preview.shouldShow && preview ) {\r\n\t\t\tpreview.hide();\r\n\t\t\tpreview = undefined;\r\n\t\t}\r\n\t};\r\n}\r\n","/**\r\n * Creates an instance of the settings change listener.\r\n *\r\n * @param {Object} boundActions\r\n * @param {Object} render function that renders a jQuery el with the settings\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function settings( boundActions, render ) {\r\n\tlet settingsObj;\r\n\r\n\treturn ( oldState, newState ) => {\r\n\t\tif ( !oldState ) {\r\n\t\t\t// Nothing to do on initialization\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (\r\n\t\t\tsettingsObj &&\r\n\t\t\tObject.keys( oldState.settings.previewTypesEnabled ).length !==\r\n\t\t\tObject.keys( newState.settings.previewTypesEnabled ).length\r\n\t\t) {\r\n\t\t\t// the number of settings changed so force it to be repainted.\r\n\t\t\tsettingsObj.refresh( newState.settings.previewTypesEnabled );\r\n\t\t}\r\n\r\n\t\t// Update global modal visibility\r\n\t\tif ( oldState.settings.shouldShow === false && newState.settings.shouldShow ) {\r\n\t\t\t// Lazily instantiate the settings UI\r\n\t\t\tif ( !settingsObj ) {\r\n\t\t\t\tsettingsObj = render( boundActions, newState.settings.previewTypesEnabled );\r\n\t\t\t\tsettingsObj.appendTo( document.body );\r\n\t\t\t}\r\n\r\n\t\t\t// Update the UI settings with the current settings\r\n\t\t\tsettingsObj.setEnabled( newState.preview.enabled );\r\n\t\t\tsettingsObj.show();\r\n\t\t} else if ( oldState.settings.shouldShow && newState.settings.shouldShow === false ) {\r\n\t\t\tsettingsObj.hide();\r\n\t\t}\r\n\r\n\t\t// Update help visibility\r\n\t\tif ( oldState.settings.showHelp !== newState.settings.showHelp ) {\r\n\t\t\tsettingsObj.toggleHelp( newState.settings.showHelp );\r\n\t\t}\r\n\t};\r\n}\r\n","/**\r\n * Creates an instance of the statsv change listener.\r\n *\r\n * The listener will log events to StatsD via the [the \"StatsD timers and\r\n * counters\" analytics event protocol][0].\r\n *\r\n * [0]: https://github.com/wikimedia/mediawiki-extensions-WikimediaEvents/blob/29c864a0/modules/ext.wikimediaEvents.statsd.js\r\n *\r\n * @param {Object} boundActions\r\n * @param {EventTracker} track\r\n * @return {ext.popups.ChangeListener}\r\n */\r\nexport default function statsv( boundActions, track ) {\r\n\treturn ( oldState, newState ) => {\r\n\t\tconst statsvObj = newState.statsv;\r\n\r\n\t\tif ( statsvObj.action ) {\r\n\t\t\ttrack( statsvObj.action, statsvObj.data );\r\n\r\n\t\t\tboundActions.statsvLogged();\r\n\t\t}\r\n\t};\r\n}\r\n","/**\r\n * @module actionTypes\r\n * @private\r\n */\r\nexport default {\r\n\tBOOT: 'BOOT',\r\n\tLINK_DWELL: 'LINK_DWELL',\r\n\tREGISTER_SETTING: 'REGISTER_SETTING',\r\n\tABANDON_START: 'ABANDON_START',\r\n\tABANDON_END: 'ABANDON_END',\r\n\tLINK_CLICK: 'LINK_CLICK',\r\n\t/** Precedes a fetch. */\r\n\tFETCH_START: 'FETCH_START',\r\n\t/** Follows a successful fetch. */\r\n\tFETCH_END: 'FETCH_END',\r\n\t/** Follows a fetch regardless of whether it was successful. */\r\n\tFETCH_COMPLETE: 'FETCH_COMPLETE',\r\n\t/** Follows an unsuccessful fetch. */\r\n\tFETCH_FAILED: 'FETCH_FAILED',\r\n\t/** Follows an aborted fetch */\r\n\tFETCH_ABORTED: 'FETCH_ABORTED',\r\n\tPAGEVIEW_LOGGED: 'PAGEVIEW_LOGGED',\r\n\tPREVIEW_DWELL: 'PREVIEW_DWELL',\r\n\tPREVIEW_SHOW: 'PREVIEW_SHOW',\r\n\tPREVIEW_CLICK: 'PREVIEW_CLICK',\r\n\t/**\r\n\t * Occurs when a preview has been opened for a significant amount of time and\r\n\t * is assumed to have been viewed.\r\n\t */\r\n\tPREVIEW_SEEN: 'PREVIEW_SEEN',\r\n\tSETTINGS_SHOW: 'SETTINGS_SHOW',\r\n\tSETTINGS_HIDE: 'SETTINGS_HIDE',\r\n\tSETTINGS_CHANGE: 'SETTINGS_CHANGE',\r\n\tSTATSV_LOGGED: 'STATSV_LOGGED'\r\n};\r\n","import types from './actionTypes';\nimport wait from './wait';\nimport { createNullModel, previewTypes, getDwellDelay } from './preview/model';\nimport { FETCH_START_DELAY, PREVIEW_SEEN_DURATION, ABANDON_END_DELAY } from './constants';\n/**\n * @module actions\n * @private\n */\n/**\n * Mixes in timing information to an action.\n *\n * Warning: the `baseAction` parameter is modified and returned.\n *\n * @param {Object} baseAction\n * @return {Object}\n */\nfunction timedAction( baseAction ) {\n\tbaseAction.timestamp = mw.now();\n\n\treturn baseAction;\n}\n\n/**\n * Represents Page Previews booting.\n *\n * When a Redux store is created, the `@@INIT` action is immediately\n * dispatched to it. To avoid overriding the term, we refer to booting rather\n * than initializing.\n *\n * Page Previews persists critical pieces of information to local storage.\n * Since reading from and writing to local storage are synchronous, Page\n * Previews is booted when the browser is idle (using\n * [`mw.requestIdleCallback`](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback))\n * so as not to impact latency-critical events.\n *\n * @param {Object} initiallyEnabled Allows to disable individual popup types while still showing the\n *  footer link\n * @param {mw.User} user\n * @param {ext.popups.UserSettings} userSettings\n * @param {mw.Map} config The config of the MediaWiki client-side application,\n *  i.e. `mw.config`\n * @param {string} url\n * @return {Object}\n */\nexport function boot(\n\tinitiallyEnabled,\n\tuser,\n\tuserSettings,\n\tconfig,\n\turl\n) {\n\tconst editCount = config.get( 'wgUserEditCount' );\n\n\treturn {\n\t\ttype: types.BOOT,\n\t\tinitiallyEnabled,\n\t\t// This is only used for logging\n\t\tisNavPopupsEnabled: config.get( 'wgPopupsConflictsWithNavPopupGadget' ),\n\t\tpageToken: user.getPageviewToken(),\n\t\tpage: {\n\t\t\turl,\n\t\t\ttitle: config.get( 'wgTitle' ),\n\t\t\tnamespaceId: config.get( 'wgNamespaceNumber' ),\n\t\t\tid: config.get( 'wgArticleId' )\n\t\t},\n\t\tuser: {\n\t\t\tisAnon: user.isAnon() || mw.user.isTemp(),\n\t\t\teditCount\n\t\t}\n\t};\n}\n\n/**\n * Registers a page preview setting for anonymous users.\n *\n * @param {string} name setting name which is used for storage and deriving associated\n *  messages.\n * @param {boolean} enabled is the feature enabled by default?\n * @return {Object}\n */\nexport function registerSetting( name, enabled ) {\n\treturn {\n\t\ttype: types.REGISTER_SETTING,\n\t\tname,\n\t\tenabled\n\t};\n}\n\n/**\n * Represents Page Previews fetching data via the gateway.\n *\n * @private\n * @param {Gateway} gateway\n * @param {mw.Title} title\n * @param {HTMLAnchorElement} el\n * @param {string} token The unique token representing the link interaction that\n *  triggered the fetch\n * @param {string} type One of the previewTypes.TYPE_ constants\n * @return {Redux.Thunk}\n */\nexport function fetch( gateway, title, el, token, type ) {\n\tconst titleText = title.getPrefixedDb(),\n\t\tnamespaceId = title.namespace;\n\n\treturn ( dispatch ) => {\n\t\tconst xhr = gateway.fetchPreviewForTitle( title, el );\n\n\t\tdispatch( timedAction( {\n\t\t\ttype: types.FETCH_START,\n\t\t\tel,\n\t\t\ttitle: titleText,\n\t\t\tnamespaceId,\n\t\t\tpromise: xhr\n\t\t} ) );\n\n\t\tconst chain = xhr\n\t\t\t.then( ( result ) => {\n\t\t\t\tdispatch( timedAction( {\n\t\t\t\t\ttype: types.FETCH_END,\n\t\t\t\t\tel\n\t\t\t\t} ) );\n\n\t\t\t\treturn result;\n\t\t\t} )\n\t\t\t.catch( ( err, data ) => {\n\t\t\t\tconst exception = new Error( err );\n\t\t\t\tconst fetchType = data && data.textStatus && data.textStatus === 'abort' ?\n\t\t\t\t\ttypes.FETCH_ABORTED : types.FETCH_FAILED;\n\n\t\t\t\texception.data = data;\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: fetchType,\n\t\t\t\t\tel,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t\t// Keep the request promise in a rejected status since it failed.\n\t\t\t\tthrow exception;\n\t\t\t} );\n\n\t\treturn Promise.all( [\n\t\t\tchain,\n\t\t\twait( getDwellDelay( type ) )\n\t\t] )\n\t\t\t.then( ( [ result ] ) => {\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: types.FETCH_COMPLETE,\n\t\t\t\t\tel,\n\t\t\t\t\tresult,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t} )\n\t\t\t.catch( ( ex ) => {\n\t\t\t\tconst result = ex.data;\n\t\t\t\tlet showNullPreview = true;\n\t\t\t\t// All failures, except those due to being offline or network error,\n\t\t\t\t// should present \"There was an issue displaying this preview\".\n\t\t\t\t// e.g.:\n\t\t\t\t// - Show (timeout): data=\"http\" {xhr: {}, textStatus: \"timeout\",\n\t\t\t\t//   exception: \"timeout\"}\n\t\t\t\t// - Show (bad MW request): data=\"unknown_action\" {error: {}}\n\t\t\t\t// - Show (RB 4xx): data=\"http\" {xhr: {}, textStatus: \"error\",\n\t\t\t\t//   exception: \"Bad Request\"}\n\t\t\t\t// - Show (RB 5xx): data=\"http\" {xhr: {}, textStatus: \"error\",\n\t\t\t\t//   exception: \"Service Unavailable\"}\n\t\t\t\t// - Suppress (offline or network error): data=\"http\"\n\t\t\t\t//   result={xhr: {}, textStatus: \"error\", exception: \"\"}\n\t\t\t\t// - Abort: data=\"http\"\n\t\t\t\t//   result={xhr: {}, textStatus: \"abort\", exception: \"abort\"}\n\n\t\t\t\tif ( result && result.xhr && result.xhr.readyState === 0 ) {\n\t\t\t\t\tconst isNetworkError = result.textStatus === 'error' && result.exception === '';\n\t\t\t\t\tshowNullPreview = !( isNetworkError || result.textStatus === 'abort' );\n\t\t\t\t}\n\n\t\t\t\tif ( ex.message === 'opensearch-no-results' ) {\n\t\t\t\t\t// No page on the English Wikipedia, but no error needed\n\t\t\t\t\tshowNullPreview = false;\n\t\t\t\t}\n\n\t\t\t\tif ( showNullPreview ) {\n\t\t\t\t\tdispatch( {\n\t\t\t\t\t\ttype: types.FETCH_COMPLETE,\n\t\t\t\t\t\tel,\n\t\t\t\t\t\tresult: createNullModel( titleText, title.getUrl() ),\n\t\t\t\t\t\ttoken\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the user dwelling on a link, either by hovering over it with\n * their mouse or by focussing it using their keyboard or an assistive device.\n *\n * @private\n * @param {mw.Title} title\n * @param {HTMLAnchorElement} el\n * @param {ext.popups.Measures} measures\n * @param {Gateway} gateway\n * @param {Function} generateToken\n * @param {string} type One of the previewTypes.TYPE_ constants\n * @return {Redux.Thunk}\n */\nexport function linkDwell( title, el, measures, gateway, generateToken, type ) {\n\tconst token = generateToken(),\n\t\ttitleText = title.getPrefixedDb(),\n\t\tnamespaceId = title.namespace;\n\n\treturn ( dispatch, getState ) => {\n\t\tconst promise = wait( FETCH_START_DELAY );\n\t\tconst action = timedAction( {\n\t\t\ttype: types.LINK_DWELL,\n\t\t\tel,\n\t\t\tpreviewType: type,\n\t\t\tmeasures,\n\t\t\ttoken,\n\t\t\ttitle: titleText,\n\t\t\tnamespaceId,\n\t\t\tpromise\n\t\t} );\n\n\t\tdispatch( action );\n\n\t\t// Has the new generated token been accepted?\n\t\tfunction isNewInteraction() {\n\t\t\treturn getState().preview.activeToken === token;\n\t\t}\n\n\t\tif ( !isNewInteraction() ) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn promise.then( () => {\n\t\t\tconst previewState = getState().preview;\n\t\t\tconst enabledValue = previewState.enabled[ type ];\n\t\t\t// If there is no UI the enabledValue is always true.\n\t\t\tconst isEnabled = typeof enabledValue === 'undefined' ? true : enabledValue;\n\n\t\t\t// The `enabled` flags allow to disable individual popup types while still showing the\n\t\t\t// footer link. This comes from the boot() action (called `initiallyEnabled` there) and\n\t\t\t// the preview() reducer.\n\t\t\t// If the preview type has not been enabled, we ignore it as it cannot be disabled\n\t\t\t// (currently) by the UI.\n\t\t\tif ( isEnabled && isNewInteraction() ) {\n\t\t\t\treturn dispatch( fetch( gateway, title, el, token, type ) );\n\t\t\t}\n\t\t} );\n\t};\n}\n\n/**\n * Represents the user abandoning a link, either by moving their mouse away\n * from it or by shifting focus to another UI element using their keyboard or\n * an assistive device, or abandoning a preview by moving their mouse away\n * from it.\n *\n * @private\n * @return {Redux.Thunk}\n */\nexport function abandon() {\n\treturn ( dispatch, getState ) => {\n\t\tconst { activeToken: token, promise } = getState().preview;\n\n\t\tif ( !token ) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tdispatch( timedAction( {\n\t\t\ttype: types.ABANDON_START,\n\t\t\ttoken\n\t\t} ) );\n\n\t\tif ( 'abort' in promise ) {\n\t\t\t// Immediately request that any outstanding fetch request be abandoned. Do not wait.\n\t\t\tpromise.abort();\n\t\t}\n\n\t\treturn wait( ABANDON_END_DELAY )\n\t\t\t.then( () => {\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: types.ABANDON_END,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the user clicking on a link with their mouse, keyboard, or an\n * assistive device.\n *\n * @param {HTMLAnchorElement} el\n * @return {Object}\n */\nexport function linkClick( el ) {\n\treturn timedAction( {\n\t\ttype: types.LINK_CLICK,\n\t\tel\n\t} );\n}\n\n/**\n * Represents the user dwelling on a preview with their mouse.\n *\n * @return {Object}\n */\nexport function previewDwell() {\n\treturn {\n\t\ttype: types.PREVIEW_DWELL\n\t};\n}\n\n/**\n * Represents a preview being shown to the user.\n *\n * This action is dispatched by the `./changeListeners/render.js` change\n * listener.\n *\n * @param {string} token\n * @return {Object}\n */\nexport function previewShow( token ) {\n\treturn ( dispatch, getState ) => {\n\t\tdispatch(\n\t\t\ttimedAction( {\n\t\t\t\ttype: types.PREVIEW_SHOW,\n\t\t\t\ttoken\n\t\t\t} )\n\t\t);\n\n\t\treturn wait( PREVIEW_SEEN_DURATION )\n\t\t\t.then( () => {\n\t\t\t\tconst state = getState(),\n\t\t\t\t\tpreview = state.preview,\n\t\t\t\t\tfetchResponse = preview && preview.fetchResponse,\n\t\t\t\t\tcurrentToken = preview && preview.activeToken,\n\t\t\t\t\tvalidType = fetchResponse && [\n\t\t\t\t\t\tpreviewTypes.TYPE_PAGE,\n\t\t\t\t\t\tpreviewTypes.TYPE_DISAMBIGUATION\n\t\t\t\t\t].indexOf( fetchResponse.type ) > -1;\n\n\t\t\t\tif (\n\t\t\t\t\t// Check the pageview can still be associated with original event\n\t\t\t\t\tcurrentToken && currentToken === token &&\n\t\t\t\t\t// and the preview is still active and of type `page`\n\t\t\t\t\tfetchResponse && validType\n\t\t\t\t) {\n\t\t\t\t\tdispatch( {\n\t\t\t\t\t\ttype: types.PREVIEW_SEEN,\n\t\t\t\t\t\ttitle: fetchResponse.title,\n\t\t\t\t\t\tpageId: fetchResponse.pageId,\n\t\t\t\t\t\t// The existing version of summary endpoint does not\n\t\t\t\t\t\t// provide namespace information, but new version\n\t\t\t\t\t\t// will. Given we only show pageviews for main namespace\n\t\t\t\t\t\t// this is hardcoded until the newer version is available.\n\t\t\t\t\t\tnamespace: 0\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the situation when a pageview has been logged\n * (see previewShow and PREVIEW_SEEN action type)\n *\n * @return {Object}\n */\nexport function pageviewLogged() {\n\treturn {\n\t\ttype: types.PAGEVIEW_LOGGED\n\t};\n}\n\n/**\n * Represents the user clicking either the \"Enable previews\" footer menu link,\n * or the \"cog\" icon that's present on each preview.\n *\n * @return {Object}\n */\nexport function showSettings() {\n\treturn {\n\t\ttype: types.SETTINGS_SHOW\n\t};\n}\n\n/**\n * Represents the user closing the settings dialog and saving their settings.\n *\n * @return {Object}\n */\nexport function hideSettings() {\n\treturn {\n\t\ttype: types.SETTINGS_HIDE\n\t};\n}\n\n/**\n * Represents the user saving their settings.\n *\n * N.B. This action returns a Redux.Thunk not because it needs to perform\n * asynchronous work, but because it needs to query the global state for the\n * current enabled state. In order to keep the enabled state in a single\n * place (the preview reducer), we query it and dispatch it as `oldValue`\n * so that other reducers (like settings) can act on it without having to\n * duplicate the `enabled` state locally.\n * See docs/adr/0003-keep-enabled-state-only-in-preview-reducer.md for more\n * details.\n *\n * @private\n * @param {Object} enabled Mapping preview type identifiers to boolean flags\n * @return {Redux.Thunk}\n */\nexport function saveSettings( enabled ) {\n\treturn ( dispatch, getState ) => {\n\t\tdispatch( {\n\t\t\ttype: types.SETTINGS_CHANGE,\n\t\t\toldValue: getState().preview.enabled,\n\t\t\tnewValue: enabled\n\t\t} );\n\t};\n}\n\n/**\n * Represents the queued statsv event being logged.\n * See `mw.popups.changeListeners.statsv` change listener.\n *\n * @return {Object}\n */\nexport function statsvLogged() {\n\treturn {\n\t\ttype: types.STATSV_LOGGED\n\t};\n}\n","import arrayWithHoles from \"./arrayWithHoles.js\";\nimport iterableToArrayLimit from \"./iterableToArrayLimit.js\";\nimport unsupportedIterableToArray from \"./unsupportedIterableToArray.js\";\nimport nonIterableRest from \"./nonIterableRest.js\";\nexport default function _slicedToArray(arr, i) {\n  return arrayWithHoles(arr) || iterableToArrayLimit(arr, i) || unsupportedIterableToArray(arr, i) || nonIterableRest();\n}","export default function _arrayWithHoles(arr) {\n  if (Array.isArray(arr)) return arr;\n}","export default function _iterableToArrayLimit(arr, i) {\n  var _i = arr == null ? null : typeof Symbol !== \"undefined\" && arr[Symbol.iterator] || arr[\"@@iterator\"];\n\n  if (_i == null) return;\n  var _arr = [];\n  var _n = true;\n  var _d = false;\n\n  var _s, _e;\n\n  try {\n    for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) {\n      _arr.push(_s.value);\n\n      if (i && _arr.length === i) break;\n    }\n  } catch (err) {\n    _d = true;\n    _e = err;\n  } finally {\n    try {\n      if (!_n && _i[\"return\"] != null) _i[\"return\"]();\n    } finally {\n      if (_d) throw _e;\n    }\n  }\n\n  return _arr;\n}","export default function _nonIterableRest() {\n  throw new TypeError(\"Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n}","/**\r\n * @module nextState\r\n * @private\r\n */\r\n\r\n/**\r\n * Creates the next state tree from the current state tree and some updates.\r\n *\r\n * N.B. OO.copy doesn't copy Element instances, whereas $.extend does.\r\n * However, OO.copy does copy properties whose values are undefined or null,\r\n * whereas $.extend doesn't. Since the state tree contains an Element instance\r\n * - the preview.activeLink property - and we want to copy undefined/null into\r\n * the state we need to manually iterate over updates and check with\r\n * hasOwnProperty to copy over to the new state.\r\n *\r\n * In [change listeners](/docs/change_listener.md), for example, we talk about\r\n * the previous state and the current state (the `oldState` and `newState`\r\n * parameters, respectively). Since\r\n * [reducers](http://redux.js.org/docs/basics/Reducers.html) take the current\r\n * state and an action and make updates, \"next state\" seems appropriate.\r\n *\r\n * @param {Object} state\r\n * @param {Object} updates\r\n * @return {Object}\r\n */\r\nexport default function nextState( state, updates ) {\r\n\tconst hasOwn = Object.prototype.hasOwnProperty,\r\n\t\tresult = {};\r\n\r\n\t// Flat clone of everything that's not updated\r\n\tfor ( const key in state ) {\r\n\t\tif ( hasOwn.call( state, key ) && !hasOwn.call( updates, key ) ) {\r\n\t\t\tresult[ key ] = state[ key ];\r\n\t\t}\r\n\t}\r\n\r\n\tfor ( const key in updates ) {\r\n\t\tif ( !hasOwn.call( updates, key ) ) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Deep clone only if there is an update\r\n\t\tif ( isObject( updates[ key ] ) ) {\r\n\t\t\tconst clone = state[ key ] ? nextState( {}, state[ key ] ) : {};\r\n\t\t\t// Recursion\r\n\t\t\tresult[ key ] = nextState( clone, updates[ key ] );\r\n\t\t} else {\r\n\t\t\tresult[ key ] = updates[ key ];\r\n\t\t}\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n\r\n/**\r\n * @param {any} obj\r\n * @return {boolean}\r\n */\r\nfunction isObject( obj ) {\r\n\t// https://javascript.plainenglish.io/javascript-check-if-a-variable-is-an-object-and-nothing-else-not-an-array-a-set-etc-a3987ea08fd7\r\n\treturn obj && obj.constructor === Object;\r\n}\r\n","export default function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}","import pageviews from './pageviews';\r\nimport preview from './preview';\r\nimport settings from './settings';\r\nimport statsv from './statsv';\r\n\r\nexport default {\r\n\tpageviews,\r\n\tpreview,\r\n\tsettings,\r\n\tstatsv\r\n};\r\n","/**\r\n * @module reducers/pageviews\r\n * @private\r\n */\r\n\r\nimport actionTypes from '../actionTypes';\r\nimport nextState from './nextState';\r\n\r\n/**\r\n * Reducer for actions that queues and clears events for\r\n * being logged as virtual pageviews [0]\r\n *\r\n * [0]: https://meta.wikimedia.org/wiki/Schema:VirtualPageViews\r\n *\r\n * @param {Object|undefined} state\r\n * @param {Object} action\r\n * @return {Object} The state resulting from reducing the action with the\r\n *  current state\r\n */\r\nexport default function pageviews( state, action ) {\r\n\tif ( state === undefined ) {\r\n\t\tstate = {\r\n\t\t\tpageview: undefined\r\n\t\t};\r\n\t}\r\n\r\n\tswitch ( action.type ) {\r\n\t\tcase actionTypes.BOOT:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tpage: action.page\r\n\t\t\t} );\r\n\t\tcase actionTypes.PAGEVIEW_LOGGED:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tpageview: undefined\r\n\t\t\t} );\r\n\t\tcase actionTypes.PREVIEW_SEEN:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tpageview: {\r\n\t\t\t\t\t/* eslint-disable camelcase */\r\n\t\t\t\t\tpage_title: action.title,\r\n\t\t\t\t\tpage_id: action.pageId,\r\n\t\t\t\t\tpage_namespace: action.namespace\r\n\t\t\t\t\t/* eslint-enable camelcase */\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\t\tdefault:\r\n\t\t\treturn state;\r\n\t}\r\n}\r\n","import actionTypes from '../actionTypes';\nimport nextState from './nextState';\n\n/**\n * Reducer for actions that modify the state of the preview model\n *\n * @param {Object|undefined} state before action\n * @param {Object} action Redux action that modified state.\n *  Must have `type` property.\n * @return {Object} state after action\n */\nexport default function preview( state, action ) {\n\tif ( state === undefined ) {\n\t\tstate = {\n\t\t\tenabled: {},\n\t\t\tactiveLink: undefined,\n\t\t\tpreviewType: undefined,\n\t\t\tmeasures: undefined,\n\t\t\tactiveToken: '',\n\t\t\tshouldShow: false,\n\t\t\tisUserDwelling: false,\n\t\t\twasClicked: false\n\t\t};\n\t}\n\n\tswitch ( action.type ) {\n\t\tcase actionTypes.BOOT:\n\t\t\treturn nextState( state, {\n\t\t\t\tenabled: action.initiallyEnabled\n\t\t\t} );\n\t\tcase actionTypes.REGISTER_SETTING:\n\t\t\treturn nextState( state, {\n\t\t\t\tenabled: Object.assign( {}, state.enabled, {\n\t\t\t\t\t[ action.name ]: action.enabled\n\t\t\t\t} )\n\t\t\t} );\n\t\tcase actionTypes.SETTINGS_CHANGE: {\n\t\t\treturn nextState( state, {\n\t\t\t\tenabled: action.newValue\n\t\t\t} );\n\t\t}\n\n\t\tcase actionTypes.LINK_DWELL:\n\t\t\tif ( action.el !== state.activeLink ) {\n\t\t\t\t// New interaction\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tactiveLink: action.el,\n\t\t\t\t\tpreviewType: action.previewType,\n\t\t\t\t\tmeasures: action.measures,\n\t\t\t\t\tactiveToken: action.token,\n\n\t\t\t\t\t// When the user dwells on a link with their keyboard, a preview is\n\t\t\t\t\t// renderered, and then dwells on another link, the ABANDON_END\n\t\t\t\t\t// action will be ignored.\n\t\t\t\t\t//\n\t\t\t\t\t// Ensure that all the preview is hidden.\n\t\t\t\t\tshouldShow: false,\n\n\t\t\t\t\tisUserDwelling: true,\n\t\t\t\t\tpromise: action.promise\n\t\t\t\t} );\n\t\t\t}\n\t\t\t// Dwelling back into the same link.\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: true\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_ABORTED:\n\t\tcase actionTypes.ABANDON_END:\n\t\t\tif ( action.token === state.activeToken && !state.isUserDwelling ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tactiveLink: undefined,\n\t\t\t\t\tpreviewType: undefined,\n\t\t\t\t\tactiveToken: undefined,\n\t\t\t\t\tmeasures: undefined,\n\t\t\t\t\tfetchResponse: undefined,\n\t\t\t\t\tshouldShow: false\n\t\t\t\t} );\n\t\t\t}\n\t\t\treturn state;\n\n\t\tcase actionTypes.PREVIEW_DWELL:\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: true\n\t\t\t} );\n\n\t\tcase actionTypes.ABANDON_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: false,\n\t\t\t\twasClicked: false\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tfetchResponse: undefined,\n\t\t\t\tpromise: action.promise\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_FAILED:\n\t\t\t// If the fetch failed and now the element has the\n\t\t\t// `opensearch-results` attribute as an empty string, we should\n\t\t\t// immediately restore the `title` text by abandoning the popup\n\t\t\t// work; unlike actions.abandon() no need to abort requests or\n\t\t\t// have a delay, since we want the title as soon as possible and\n\t\t\t// there should not be any open requests\n\t\t\tif ( action.el &&\n\t\t\t\taction.el.hasAttribute( 'opensearch-results' ) &&\n\t\t\t\taction.el.getAttribute( 'opensearch-results' ) === '' &&\n\t\t\t\t// Match the token condition from ABANDON_END above, but not\n\t\t\t\t// the isUserDwelling one, which would have been set to false\n\t\t\t\t// by the ABANDON_START handler above\n\t\t\t\taction.token === state.activeToken\n\t\t\t) {\n\t\t\t\t// Match the result from ABANDON_END above, but also set\n\t\t\t\t// isUserDwelling to false\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tactiveLink: undefined,\n\t\t\t\t\tpreviewType: undefined,\n\t\t\t\t\tactiveToken: undefined,\n\t\t\t\t\tmeasures: undefined,\n\t\t\t\t\tfetchResponse: undefined,\n\t\t\t\t\tshouldShow: false,\n\t\t\t\t\tisUserDwelling: false\n\t\t\t\t} );\n\t\t\t}\n\t\t\t// No change\n\t\t\treturn state;\n\n\t\tcase actionTypes.FETCH_COMPLETE:\n\t\t\tif ( action.token === state.activeToken ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tfetchResponse: action.result,\n\t\t\t\t\tshouldShow: state.isUserDwelling\n\t\t\t\t} );\n\t\t\t} // else fall through\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","import actionTypes from '../actionTypes';\r\nimport nextState from './nextState';\r\n\r\n/**\r\n * Reducer for actions that modify the state of the settings\r\n *\r\n * @param {Object|undefined} state\r\n * @param {Object} action\r\n * @return {Object} state after action\r\n */\r\nexport default function settings( state, action ) {\r\n\tif ( state === undefined ) {\r\n\t\tstate = {\r\n\t\t\tshouldShow: false,\r\n\t\t\tpreviewTypesEnabled: {},\r\n\t\t\tshowHelp: false,\r\n\t\t\tshouldShowFooterLink: false\r\n\t\t};\r\n\t}\r\n\r\n\tswitch ( action.type ) {\r\n\t\tcase actionTypes.SETTINGS_SHOW:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tshouldShow: true,\r\n\t\t\t\tshowHelp: false\r\n\t\t\t} );\r\n\t\tcase actionTypes.SETTINGS_HIDE:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tshouldShow: false,\r\n\t\t\t\tshowHelp: false\r\n\t\t\t} );\r\n\t\tcase actionTypes.SETTINGS_CHANGE: {\r\n\t\t\tconst types = Object.keys( action.newValue ),\r\n\t\t\t\tnothingChanged = types\r\n\t\t\t\t\t.every( ( type ) => action.oldValue[ type ] === action.newValue[ type ] ),\r\n\t\t\t\t// Check if at least one setting has been deactivated that was active before\r\n\t\t\t\tuserOptedOut = types\r\n\t\t\t\t\t.some( ( type ) => action.oldValue[ type ] && !action.newValue[ type ] ),\r\n\t\t\t\t// Warning, when the state is null the user can't re-enable this popup type!\r\n\t\t\t\tanyDisabled = types\r\n\t\t\t\t\t.some( ( type ) => action.newValue[ type ] === false );\r\n\r\n\t\t\tif ( nothingChanged ) {\r\n\t\t\t\t// If the setting is the same, just hide the dialogs\r\n\t\t\t\treturn nextState( state, {\r\n\t\t\t\t\tshouldShow: false\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\t// If we enabled, we just hide directly, no help\r\n\t\t\t\t// If we disabled, keep it showing and let the ui show the help.\r\n\t\t\t\tshouldShow: userOptedOut,\r\n\t\t\t\tshowHelp: userOptedOut,\r\n\r\n\t\t\t\t// Since the footer link is only ever shown to anonymous users (see\r\n\t\t\t\t// the BOOT case below), state.userIsAnon is always truthy here.\r\n\t\t\t\tshouldShowFooterLink: anyDisabled\r\n\t\t\t} );\r\n\t\t}\r\n\t\tcase actionTypes.REGISTER_SETTING: {\r\n\t\t\tconst previewTypesEnabled = Object.assign( {}, state.previewTypesEnabled, {\r\n\t\t\t\t[ action.name ]: action.enabled\r\n\t\t\t} );\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tpreviewTypesEnabled,\r\n\t\t\t\tshouldShowFooterLink: state.shouldShowFooterLink || !action.enabled\r\n\t\t\t} );\r\n\t\t}\r\n\t\tcase actionTypes.BOOT: {\r\n\t\t\t// Warning, when the state is null the user can't re-enable this popup type!\r\n\t\t\tconst anyDisabled = Object.keys( action.initiallyEnabled )\r\n\t\t\t\t.some( ( type ) => action.initiallyEnabled[ type ] === false );\r\n\t\t\tconst previewTypesEnabled = Object.assign( {}, action.initiallyEnabled );\r\n\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tpreviewTypesEnabled,\r\n\t\t\t\tshouldShowFooterLink: action.user.isAnon && anyDisabled\r\n\t\t\t} );\r\n\t\t}\r\n\t\tdefault:\r\n\t\t\treturn state;\r\n\t}\r\n}\r\n","import actionTypes from './../actionTypes';\r\nimport nextState from './nextState';\r\n\r\n/**\r\n * Reducer for actions that may result in an event being logged via statsv.\r\n *\r\n * @param {Object|undefined} state\r\n * @param {Object} action\r\n * @return {Object} state after action\r\n */\r\nexport default function statsv( state, action ) {\r\n\tstate = state || {};\r\n\r\n\tswitch ( action.type ) {\r\n\t\tcase actionTypes.FETCH_START:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tfetchStartedAt: action.timestamp\r\n\t\t\t} );\r\n\r\n\t\tcase actionTypes.FETCH_END:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\taction: 'timing.PagePreviewsApiResponse',\r\n\t\t\t\tdata: action.timestamp - state.fetchStartedAt\r\n\t\t\t} );\r\n\r\n\t\tcase actionTypes.FETCH_FAILED:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\taction: 'counter.PagePreviewsApiFailure',\r\n\t\t\t\tdata: 1\r\n\t\t\t} );\r\n\r\n\t\tcase actionTypes.LINK_DWELL:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\tlinkDwellStartedAt: action.timestamp\r\n\t\t\t} );\r\n\r\n\t\tcase actionTypes.PREVIEW_SHOW:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\taction: 'timing.PagePreviewsPreviewShow',\r\n\t\t\t\tdata: action.timestamp - state.linkDwellStartedAt\r\n\t\t\t} );\r\n\r\n\t\tcase actionTypes.STATSV_LOGGED:\r\n\t\t\treturn nextState( state, {\r\n\t\t\t\taction: null,\r\n\t\t\t\tdata: null\r\n\t\t\t} );\r\n\r\n\t\tdefault:\r\n\t\t\treturn state;\r\n\t}\r\n}\r\n","import * as Redux from 'redux';\nimport * as ReduxThunk from 'redux-thunk';\n\nimport createPagePreviewGateway from './gateway/page';\nimport createUserSettings from './userSettings';\nimport createPreviewBehavior from './previewBehavior';\nimport createSettingsDialogRenderer from './ui/settingsDialogRenderer';\nimport registerChangeListener from './changeListener';\nimport createIsPagePreviewsEnabled from './isPagePreviewsEnabled';\nimport { fromElement as titleFromElement } from './title';\nimport { init as rendererInit, registerPreviewUI, createPagePreview,\n\tcreateDisambiguationPreview\n} from './ui/renderer';\nimport createExperiments from './experiments';\nimport { isEnabled as isStatsvEnabled } from './instrumentation/statsv';\nimport changeListeners from './changeListeners';\nimport * as actions from './actions';\nimport reducers from './reducers';\nimport createMediaWikiPopupsObject from './integrations/mwpopups';\nimport { previewTypes, getPreviewType,\n\tregisterModel, findNearestEligibleTarget } from './preview/model';\nimport setUserConfigFlags from './setUserConfigFlags';\nimport { registerGatewayForPreviewType, getGatewayForPreviewType } from './gateway';\nimport { FETCH_START_DELAY, FETCH_COMPLETE_TARGET_DELAY } from './constants';\n/**\n * @module popups\n * @private\n */\nconst EXCLUDED_LINK_SELECTORS = [\n\t'.extiw',\n\t// ignore links that point to the same article\n\t'.mw-selflink',\n\t'.image',\n\t// Since we are fetching from the English Wikipedia, ignore if a local page\n\t// does not exist; SEL-1387\n\t// '.new',\n\t'.internal',\n\t'.external',\n\t'.mw-cite-backlink a',\n\t'.oo-ui-buttonElement-button',\n\t'.ve-ce-surface a', // T259889\n\t'.ext-discussiontools-init-timestamplink',\n\t'.cancelLink a',\n\t// T198652: lists to hash fragments are ignored.\n\t// Note links that include the path will still trigger a hover,\n\t// e.g. <a href=\"Foo#foo\"> will trigger a preview but <a href=\"#foo\"> will not.\n\t// This is intentional behaviour that will not be handled by page previews, to avoid\n\t// introducing complex behaviour. If a link must include the path it should make use of\n\t// the .mw-selflink-fragment class.\n\t'.mw-selflink-fragment',\n\t'[href^=\"#\"]'\n];\n\n/**\n * @typedef {Function} EventTracker\n *\n * An analytics event tracker, i.e. `mw.track`.\n *\n * @param {string} topic\n * @param {Object} data\n */\n\n/**\n * Gets the appropriate analytics event tracker for logging metrics to StatsD\n * via [the \"StatsD timers and counters\" analytics event protocol][0].\n *\n * If logging metrics to StatsD is enabled for the duration of the user's\n * session, then the appriopriate function is `mw.track`; otherwise it's\n * `() => {}`.\n *\n * [0]: https://github.com/wikimedia/mediawiki-extensions-WikimediaEvents/blob/29c864a0/modules/ext.wikimediaEvents.statsd.js\n *\n * @param {Object} user\n * @param {Object} config\n * @param {Experiments} experiments\n * @return {EventTracker}\n */\nfunction getStatsvTracker( user, config, experiments ) {\n\treturn isStatsvEnabled( user, config, experiments ) ? mw.track : () => {};\n}\n\n/**\n * Gets the appropriate analytics event tracker for logging virtual pageviews.\n *\n * @param {Object} config\n * @return {EventTracker}\n */\nfunction getPageviewTracker( config ) {\n\treturn config.get( 'wgPopupsVirtualPageViews' ) ? mw.track : () => {\n\t\t// NOP\n\t};\n}\n\n/**\n * Subscribes the registered change listeners to the\n * [store](http://redux.js.org/docs/api/Store.html#store).\n *\n * @param {Redux.Store} store\n * @param {Object} registerActions\n * @param {UserSettings} userSettings\n * @param {Function} settingsDialog\n * @param {PreviewBehavior} previewBehavior\n * @param {EventTracker} statsvTracker\n * @param {EventTracker} pageviewTracker\n */\nfunction registerChangeListeners(\n\tstore, registerActions, userSettings, settingsDialog, previewBehavior,\n\tstatsvTracker, pageviewTracker\n) {\n\tregisterChangeListener( store, changeListeners.footerLink( registerActions ) );\n\tregisterChangeListener( store, changeListeners.linkTitle() );\n\tregisterChangeListener( store, changeListeners.render( previewBehavior ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.statsv( registerActions, statsvTracker ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.syncUserSettings( userSettings ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.settings( registerActions, settingsDialog ) );\n\tregisterChangeListener( store,\n\t\tchangeListeners.pageviews( registerActions, pageviewTracker )\n\t);\n}\n\n/**\n * Creates an event handler that only executes if the current target\n * is eligible for page previews and a title can be associated with the element.\n *\n * @param {Function} handler\n * @return {Function}\n */\nfunction handleDOMEventIfEligible( handler ) {\n\treturn function ( event ) {\n\t\tlet target = event && event.target;\n\t\tif ( !target ) {\n\t\t\treturn;\n\t\t}\n\t\t// if the element is a text node, as events can be triggered on text nodes\n\t\t// it won't have a closest method, so we get its parent element (T340081)\n\t\tif ( target.nodeType === 3 ) {\n\t\t\ttarget = target.parentNode;\n\t\t}\n\n\t\t// If the event bubbles up all the way,\n\t\t// document does not have closest method, so exit early (T336650).\n\t\tif ( target === document ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If the closest method is not defined, let's return early and\n\t\t// understand this better by logging an error. (T340081)\n\t\tif ( target && !target.closest ) {\n\t\t\tconst err = new Error( `T340081: Unexpected DOM element ${ target.tagName } with nodeType ${ target.nodeType }` );\n\t\t\tmw.errorLogger.logError( err, 'error.web-team' );\n\t\t\treturn;\n\t\t}\n\n\t\ttarget = findNearestEligibleTarget( target );\n\t\tif ( target === null ) {\n\t\t\treturn;\n\t\t}\n\t\tconst mwTitle = titleFromElement( target, mw.config );\n\t\tif ( mwTitle ) {\n\t\t\thandler( target, mwTitle, event );\n\t\t}\n\t};\n}\n/*\n * Initialize the application by:\n * 1. Initializing side-effects and \"services\"\n * 2. Creating the state store\n * 3. Binding the actions to such store\n * 4. Registering change listeners\n * 5. Triggering the boot action to bootstrap the system\n * 6. When the page content is ready:\n *   - Initializing the renderer\n *   - Binding hover and click events to the eligible links to trigger actions\n */\n( function init() {\n\tsetUserConfigFlags( mw.config );\n\n\tlet compose = Redux.compose;\n\tconst\n\t\t// So-called \"services\".\n\t\tgenerateToken = mw.user.generateRandomSessionId,\n\t\tpagePreviewGateway = createPagePreviewGateway( mw.config ),\n\t\tuserSettings = createUserSettings( mw.storage ),\n\t\tsettingsDialog = createSettingsDialogRenderer(),\n\t\texperiments = createExperiments( mw.experiments ),\n\t\tstatsvTracker = getStatsvTracker( mw.user, mw.config, experiments ),\n\t\tpageviewTracker = getPageviewTracker( mw.config ),\n\t\tpagePreviewState = createIsPagePreviewsEnabled( mw.user, userSettings, mw.config );\n\n\t// If debug mode is enabled, then enable Redux DevTools.\n\tif ( mw.config.get( 'debug' ) ||\n\t\t/* global process */\n\t\tprocess.env.NODE_ENV !== 'production' ) {\n\t\t// eslint-disable-next-line no-underscore-dangle\n\t\tcompose = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;\n\t}\n\n\tconst store = Redux.createStore(\n\t\tRedux.combineReducers( reducers ),\n\t\tcompose( Redux.applyMiddleware(\n\t\t\tReduxThunk.default\n\t\t) )\n\t);\n\tconst boundActions = Redux.bindActionCreators( actions, store.dispatch );\n\tconst previewBehavior = createPreviewBehavior( mw.user, boundActions );\n\n\tregisterChangeListeners(\n\t\tstore, boundActions, userSettings, settingsDialog,\n\t\tpreviewBehavior, statsvTracker, pageviewTracker\n\t);\n\n\tboundActions.boot(\n\t\t{},\n\t\tmw.user,\n\t\tuserSettings,\n\t\tmw.config,\n\t\twindow.location.href\n\t);\n\n\t/*\n\t * Register external interface exposing popups internals so that other\n\t * extensions can query it (T171287)\n\t */\n\tmw.popups = createMediaWikiPopupsObject(\n\t\tstore, registerModel, registerPreviewUI, registerGatewayForPreviewType,\n\t\tboundActions.registerSetting, userSettings\n\t);\n\n\t// Migrate any old preferences to new system.\n\t// FIXME: This can be removed in 4 weeks time.\n\tuserSettings.migrateOldPreferences();\n\n\tif ( pagePreviewState !== null ) {\n\t\tconst excludedLinksSelector = EXCLUDED_LINK_SELECTORS.join( ', ' );\n\t\t// Register default preview type\n\t\tmw.popups.register( {\n\t\t\ttype: previewTypes.TYPE_PAGE,\n\t\t\tselector: `#mw-content-text a[href][title]:not(${ excludedLinksSelector })`,\n\t\t\tdelay: FETCH_COMPLETE_TARGET_DELAY - FETCH_START_DELAY,\n\t\t\tgateway: pagePreviewGateway,\n\t\t\trenderFn: createPagePreview,\n\t\t\tsubTypes: [\n\t\t\t\t{\n\t\t\t\t\ttype: previewTypes.TYPE_DISAMBIGUATION,\n\t\t\t\t\trenderFn: createDisambiguationPreview,\n\t\t\t\t\tdoNotRequireSummary: true\n\t\t\t\t}\n\t\t\t]\n\t\t} );\n\t}\n\n\trendererInit();\n\n\t/*\n\t * Binding hover and click events to the eligible links to trigger actions\n\t */\n\tfunction setupEventListeners() {\n\t\tconst onHover = handleDOMEventIfEligible( function ( target, mwTitle, event ) {\n\t\t\tconst type = getPreviewType( target );\n\t\t\tconst gateway = getGatewayForPreviewType( type );\n\t\t\tif ( !gateway ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst scrollTop = window.scrollY;\n\t\t\tconst bbox = target.getBoundingClientRect();\n\t\t\tconst offset = {\n\t\t\t\ttop: scrollTop + bbox.y,\n\t\t\t\tleft: window.scrollX + bbox.x\n\t\t\t};\n\t\t\tconst measures = {\n\t\t\t\tpageX: event.pageX,\n\t\t\t\tpageY: event.pageY,\n\t\t\t\tclientY: event.clientY,\n\t\t\t\twidth: target.offsetWidth,\n\t\t\t\theight: target.offsetHeight,\n\t\t\t\toffset,\n\t\t\t\tclientRects: target.getClientRects(),\n\t\t\t\twindowWidth: window.innerWidth,\n\t\t\t\twindowHeight: window.innerHeight,\n\t\t\t\tscrollTop\n\t\t\t};\n\n\t\t\tboundActions.linkDwell( mwTitle, target, measures, gateway, generateToken, type );\n\t\t} );\n\t\tconst onHoverOut = handleDOMEventIfEligible( function () {\n\t\t\tboundActions.abandon();\n\t\t} );\n\t\tconst onClick = handleDOMEventIfEligible( function ( target ) {\n\t\t\tif ( previewTypes.TYPE_PAGE === getPreviewType( target ) ) {\n\t\t\t\tboundActions.linkClick( target );\n\t\t\t}\n\t\t} );\n\t\tdocument.addEventListener( 'mouseover', onHover );\n\t\tdocument.addEventListener( 'keyup', onHover );\n\t\tdocument.addEventListener( 'mouseout', onHoverOut );\n\t\tdocument.addEventListener( 'blur', onHoverOut );\n\t\tdocument.addEventListener( 'click', onClick );\n\t}\n\tsetupEventListeners();\n}() );\n\nwindow.Redux = Redux;\nwindow.ReduxThunk = ReduxThunk;\n","/**\n * @module title\n * @private\n */\n\n/**\n * Fast, native check if we are parsing a self-link, with the only difference beeing the hash.\n *\n * @param {HTMLAnchorElement} el\n * @return {boolean}\n */\nfunction isOwnPageAnchorLink( el ) {\n\treturn el.hash &&\n\t\t// Note: The protocol is ignored for the sake of simplicity.\n\t\t// Can't compare username and password because they aren't readable from `location`.\n\t\tel.host === location.host &&\n\t\tel.pathname === location.pathname &&\n\t\tel.search === location.search;\n}\n\n/**\n * Gets the title of a local page from an href given some configuration.\n *\n * @param {string} href\n * @param {mw.Map} config\n * @return {string|undefined}\n */\nexport function getTitle( href, config ) {\n\t// Skip every URI that mw.Uri cannot parse\n\tlet linkHref;\n\ttry {\n\t\tlinkHref = new mw.Uri( href );\n\t} catch ( e ) {\n\t\treturn undefined;\n\t}\n\n\t// External links\n\tif ( linkHref.host !== location.hostname ) {\n\t\treturn undefined;\n\t}\n\n\t// If pages that do not exist locally, ignore that, since we are fetching\n\t// from the English Wikipedia\n\tif ( linkHref.query.redlink === '1' && linkHref.query.action === 'edit' ) {\n\t\tdelete linkHref.query.redlink;\n\t\tdelete linkHref.query.action;\n\t}\n\n\tconst queryLength = Object.keys( linkHref.query ).length;\n\tlet title;\n\n\t// No query params (pretty URL)\n\tif ( !queryLength ) {\n\t\tconst pattern = mw.util.escapeRegExp( config.get( 'wgArticlePath' ) ).replace( '\\\\$1', '([^?#]+)' ),\n\t\t\t// eslint-disable-next-line security/detect-non-literal-regexp\n\t\t\tmatches = new RegExp( pattern ).exec( linkHref.path );\n\n\t\t// We can't be sure decodeURIComponent() is able to parse every possible match\n\t\ttry {\n\t\t\ttitle = matches && decodeURIComponent( matches[ 1 ] );\n\t\t} catch ( e ) {\n\t\t\t// Will return undefined below\n\t\t}\n\t} else if ( queryLength === 1 && 'title' in linkHref.query ) {\n\t\t// URL is not pretty, but only has a `title` parameter\n\t\ttitle = linkHref.query.title;\n\t}\n\n\treturn title ? `${ title }${ linkHref.fragment ? `#${ linkHref.fragment }` : '' }` : undefined;\n}\n\n/**\n * Given a page title it will return the mediawiki.Title if it is an eligible\n * link for showing page previews, null otherwise\n *\n * @param {string|undefined} title page title to check if it should show preview\n * @param {number[]} contentNamespaces contentNamespaces as specified in\n * wgContentNamespaces\n * @return {mw.Title|null}\n */\nexport function isValid( title, contentNamespaces ) {\n\tif ( !title ) {\n\t\treturn null;\n\t}\n\n\t// Is title in a content namespace?\n\tconst mwTitle = mw.Title.newFromText( title );\n\tif ( mwTitle && contentNamespaces.indexOf( mwTitle.namespace ) >= 0 ) {\n\t\treturn mwTitle;\n\t}\n\n\treturn null;\n}\n\n/**\n * Return an mw.Title from an HTMLAnchorElement if valid for page previews. Convenience\n * method\n *\n * @param {HTMLAnchorElement} el\n * @param {mw.Map} config\n * @return {mw.Title|null}\n */\nexport function fromElement( el, config ) {\n\tif ( el.dataset.title ) {\n\t\treturn mw.Title.newFromText( el.dataset.title );\n\t}\n\tif ( isOwnPageAnchorLink( el ) ) {\n\t\t// No need to check the namespace. A self-link can't point to different one.\n\t\ttry {\n\t\t\treturn mw.Title.newFromText( config.get( 'wgPageName' ) + decodeURIComponent( el.hash ) );\n\t\t} catch ( e ) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\treturn isValid(\n\t\tgetTitle( el.href, config ),\n\t\tconfig.get( 'wgContentNamespaces' )\n\t);\n}\n","/**\r\n * @module setUserConfigFlags\r\n * @private\r\n */\r\n\r\n/**\r\n * Same as in includes/PopupsContext.php\r\n */\r\nconst NAV_POPUPS_ENABLED = 1;\r\n\r\n/**\r\n * Decodes the bitmask that represents preferences to the related config options.\r\n *\r\n * @param {mw.Map} config\r\n */\r\nexport default function setUserConfigFlags( config ) {\r\n\tconst popupsFlags = parseInt( config.get( 'wgPopupsFlags' ), 10 );\r\n\r\n\t/* eslint-disable no-bitwise */\r\n\tconfig.set(\r\n\t\t'wgPopupsConflictsWithNavPopupGadget',\r\n\t\t!!( popupsFlags & NAV_POPUPS_ENABLED )\r\n\t);\r\n\t/* eslint-enable no-bitwise */\r\n}\r\n","/**\r\n * @module experiments\r\n * @private\r\n */\r\n\r\n/**\r\n * Creates a helper wrapper for the MediaWiki-provided\r\n * `mw.experiments#getBucket` bucketing function.\r\n *\r\n * @param {mw.experiments} mwExperiments The `mw.experiments` singleton instance\r\n * @return {Experiments}\r\n */\r\nexport default function createExperiments( mwExperiments ) {\r\n\treturn {\r\n\t\t/**\r\n\t\t * Gets whether something is true given a name and a token.\r\n\t\t *\r\n\t\t * @example\r\n\t\t * import createExperiments from './src/experiments';\r\n\t\t * const experiments = createExperiments( mw.experiments );\r\n\t\t * const isFooEnabled = experiments.weightedBoolean(\r\n\t\t *   'foo',\r\n\t\t *   10 / 100, // 10% of all unique tokens should have foo enabled.\r\n\t\t *   token\r\n\t\t * );\r\n\t\t *\r\n\t\t * @method\r\n\t\t * @name Experiments#weightedBoolean\r\n\t\t * @param {string} name The name of the thing. Since this is used as the\r\n\t\t *  name of the underlying experiment it should be unique to reduce the\r\n\t\t *  likelihood of collisions with other enabled experiments\r\n\t\t * @param {number} trueWeight A number between 0 and 1, representing the\r\n\t\t *  probability of the thing being true\r\n\t\t * @param {string} token A token associated with the user for the duration\r\n\t\t *  of the experiment\r\n\t\t * @return {boolean}\r\n\t\t */\r\n\t\tweightedBoolean( name, trueWeight, token ) {\r\n\t\t\treturn mwExperiments.getBucket( {\r\n\t\t\t\tenabled: true,\r\n\r\n\t\t\t\tname,\r\n\t\t\t\tbuckets: {\r\n\t\t\t\t\ttrue: trueWeight,\r\n\t\t\t\t\tfalse: 1 - trueWeight\r\n\t\t\t\t}\r\n\t\t\t}, token ) === 'true';\r\n\t\t}\r\n\t};\r\n}\r\n","/**\n * @module gateway/restWithSearch\n */\n\n/** @typedef {function(JQuery.AjaxSettings=): JQuery.jqXHR} Ajax */\n\nimport restGatewayCreator from './rest.js';\nimport { previewTypes } from '../preview/model';\n\n/**\n * Wraps an instance of the restbase gateway with an opensearch api call,\n * hard-coded to use the English wikipedia; if there is a page that is found\n * from that call, restbase is then used to render that page; if there are\n * no results, modifies the link element to indicate that, so further attempts\n * to query are skipped, and rejects with the special code\n * `opensearch-no-results` so that no failure popup is shown.\n *\n * @param {Ajax} ajax A function with the same signature as `jQuery.ajax`\n * @param {Object} config Configuration that affects the major behavior of the\n *  gateway.\n * @param {Function} extractParser A function that takes response and returns\n *  parsed extract\n * @param {mw.ForeignApi} enwikiAPI\n * @return {Gateway}\n */\nexport default function createRestOpenSearchGateWay(\n\tajax,\n\tconfig,\n\textractParser,\n\tenwikiAPI\n) {\n\n\tconst restParts = restGatewayCreator( ajax, config, extractParser );\n\n\t/**\n\t * We need to export a fetch() method, but I don't think it actually gets\n\t * used directly, which is good since we need 2 fetches, so just don't\n\t * allow using it\n\t */\n\tfunction fetch() {\n\t\tthrow new Error( 'Rest+Search fetch() should not be used!' );\n\t}\n\n\t/**\n\t * Update model link to point to the English Wikipedia, SEL-1348\n\t *\n\t * @param {PagePreviewModel} model\n\t * @return {PagePreviewModel}\n\t */\n\tfunction updatePreviewLink( model ) {\n\t\tconst uri = new mw.Uri( model.url );\n\t\t// Point to the English Wikipedia and use https\n\t\turi.host = 'en.wikipedia.org';\n\t\turi.protocol = 'https';\n\t\t// Drop some parts that might be set from the local wiki\n\t\turi.password = undefined;\n\t\turi.port = undefined;\n\t\tmodel.url = uri.toString();\n\t\treturn model;\n\t}\n\n\t/**\n\t * Wrapper around the rest base implementation of fetchPreviewForTitle(),\n\t * except that we also need to update the link URLs, SEL-1348\n\t *\n\t * @param {mw.Title} title\n\t * @param {HTMLAnchorElement} link\n\t * @return {AbortPromise<PagePreviewModel>}\n\t */\n\tfunction fetchPreviewForTitle( title, link ) {\n\t\t// No need to do the lookup multiple times\n\t\tif ( link.hasAttribute( 'opensearch-results' ) ) {\n\t\t\tconst foundTitle = link.getAttribute( 'opensearch-results' );\n\t\t\t// If we know that there is no title, just skip, but without showing\n\t\t\t// an error. Ideally, we wouldn't even try to fetch the preview and\n\t\t\t// get to this function in such a case, but we cannot just skip\n\t\t\t// such cases in the creation of titles from elements (title.js)\n\t\t\t// since we also need to work when the user moves off of the link\n\t\t\t// with no results the first time\n\t\t\tif ( foundTitle === '' ) {\n\t\t\t\treturn $.Deferred().reject( 'opensearch-no-results' );\n\t\t\t}\n\t\t\treturn restParts.fetchPreviewForTitle(\n\t\t\t\tnew mw.Title( foundTitle ),\n\t\t\t\tlink\n\t\t\t).then( ( model ) => updatePreviewLink( model ) );\n\t\t}\n\n\t\treturn enwikiAPI.get( {\n\t\t\taction: 'opensearch',\n\t\t\tsearch: title.getPrefixedDb(),\n\t\t\tlimit: '1'\n\t\t} ).then(\n\t\t\t( data ) => {\n\t\t\t\tif ( data.length !== 4 ) {\n\t\t\t\t\tlink.setAttribute( 'opensearch-results', '' );\n\t\t\t\t\treturn $.Deferred().reject( 'opensearch-no-results' );\n\t\t\t\t}\n\t\t\t\tconst pageNames = data[ 1 ];\n\t\t\t\tif ( !Array.isArray( pageNames ) || pageNames.length === 0 ) {\n\t\t\t\t\tlink.setAttribute( 'opensearch-results', '' );\n\t\t\t\t\treturn $.Deferred().reject( 'opensearch-no-results' );\n\t\t\t\t}\n\t\t\t\tconst pageName = pageNames[ 0 ];\n\t\t\t\tlink.setAttribute( 'opensearch-results', pageName );\n\t\t\t\treturn restParts.fetchPreviewForTitle(\n\t\t\t\t\tnew mw.Title( pageName )\n\t\t\t\t).then( ( model ) => {\n\t\t\t\t\tif ( model.type === previewTypes.TYPE_GENERIC ||\n\t\t\t\t\t\tmodel.type === previewTypes.TYPE_DISAMBIGUATION\n\t\t\t\t\t) {\n\t\t\t\t\t\t// For pages with no summary to show, we don't show a\n\t\t\t\t\t\t// popup at all - just reuse the logic from if there\n\t\t\t\t\t\t// were no search results, which will also prevent\n\t\t\t\t\t\t// future rendering attempts\n\t\t\t\t\t\t// Same with disambiguation pages\n\t\t\t\t\t\tlink.setAttribute( 'opensearch-results', '' );\n\t\t\t\t\t\treturn $.Deferred().reject( 'opensearch-no-results' );\n\t\t\t\t\t}\n\t\t\t\t\treturn updatePreviewLink( model );\n\t\t\t\t} );\n\t\t\t},\n\t\t\t// catch() handler, but NOT attaching with .catch() because we do\n\t\t\t// not want this to catch the rejections with opensearch-no-results\n\t\t\t// that are set up above\n\t\t\t( jqXHR, textStatus, errorThrown ) => {\n\t\t\t\t// Match the default rest handling\n\t\t\t\treturn $.Deferred().reject( 'http', {\n\t\t\t\t\txhr: jqXHR,\n\t\t\t\t\ttextStatus,\n\t\t\t\t\texception: errorThrown\n\t\t\t\t} );\n\t\t\t}\n\t\t).promise( { abort() { enwikiAPI.abort(); } } );\n\t}\n\n\treturn {\n\t\tfetch,\n\t\tconvertPageToModel: restParts.convertPageToModel,\n\t\tfetchPreviewForTitle\n\t};\n}\n","/**\r\n * @module instrumentation/statsv\r\n * @private\r\n */\r\n\r\n/**\r\n * Gets whether Graphite logging (via [the statsv HTTP endpoint][0]) is enabled\r\n * for the duration of the user's session. The bucketing rate is controlled by\r\n * `wgPopupsStatsvSamplingRate`.\r\n *\r\n * [0]: https://wikitech.wikimedia.org/wiki/Graphite#statsv\r\n *\r\n * @param {mw.User} user The `mw.user` singleton instance\r\n * @param {mw.Map} config The `mw.config` singleton instance\r\n * @param {Experiments} experiments\r\n * @return {boolean}\r\n */\r\nexport function isEnabled( user, config, experiments ) {\r\n\tconst bucketingRate = config.get( 'wgPopupsStatsvSamplingRate', 0 );\r\n\tif ( bucketingRate === 0 || bucketingRate === 1 ) {\r\n\t\t// Avoid calling user.sessionId() if possible, since it sets a cookie\r\n\t\treturn !!bucketingRate;\r\n\t}\r\n\r\n\treturn experiments.weightedBoolean(\r\n\t\t'ext.Popups.statsv',\r\n\t\tbucketingRate,\r\n\t\tuser.sessionId()\r\n\t);\r\n}\r\n","/**\r\n * The public facing MediaWiki Popups API.\r\n *\r\n * @module mw.popups\r\n */\r\n\r\nimport { previewTypes } from '../preview/model';\r\n\r\n/**\r\n * @private\r\n * @param {string} type\r\n * @return {boolean} whether the preview type supports being disabled/enabled.\r\n */\r\nfunction canShowSettingForPreviewType( type ) {\r\n\treturn mw.message( `popups-settings-option-${ type }` ).exists();\r\n}\r\n\r\n/**\r\n * This function provides a mw.popups object which can be used by 3rd party\r\n * to interact with Popups.\r\n *\r\n * @ignore\r\n * @param {Redux.Store} store Popups store\r\n * @param {Function} registerModel allows extensions to register custom preview handlers.\r\n * @param {Function} registerPreviewUI allows extensions to register custom preview renderers.\r\n * @param {Function} registerGatewayForPreviewType allows extensions to register gateways for\r\n * preview types.\r\n * @param {Function} registerSetting\r\n * @param {UserSettings} userSettings\r\n * @return {Object} external Popups interface\r\n */\r\nexport default function createMwPopups( store, registerModel, registerPreviewUI,\r\n\tregisterGatewayForPreviewType, registerSetting, userSettings\r\n) {\r\n\treturn {\r\n\t\t/**\r\n\t\t * @param {string} [type] type of preview, defaults to page if not provided.\r\n\t\t * @return {boolean} If Page Previews are currently active\r\n\t\t */\r\n\t\tisEnabled: function isEnabled( type ) {\r\n\t\t\treturn !!store.getState().preview.enabled[ type || previewTypes.TYPE_PAGE ];\r\n\t\t},\r\n\t\t/**\r\n\t\t * @stable Do not remove properties in the type PopupModule without providing backwards\r\n\t\t * compatibility and code that handles migrations.\r\n\t\t *\r\n\t\t * @typedef {Object} PopupSubtype\r\n\t\t * @property {string} type A unique string for identifying the subtype of a page preview\r\n\t\t * @property {function(ext.popups.PreviewModel): ext.popups.Preview}[renderFn] How the\r\n\t\t * custom preview type will render the preview. If not provided default renderer is used.\r\n\t\t *\r\n\t\t * @typedef {Object} PopupModule\r\n\t\t * @private\r\n\t\t * @property {string} type A unique string for identifying the type of page preview\r\n\t\t * @property {string} selector A CSS selector which identifies elements that will display\r\n\t\t * this type of page preview\r\n\t\t * @property {Gateway} gateway A Gateway for obtaining the preview data.\r\n\t\t * @property {function(ext.popups.PreviewModel): ext.popups.Preview}[renderFn] How the\r\n\t\t * custom preview type will render the preview.\r\n\t\t *  If not provided default renderer is used.\r\n\t\t * @property {PopupSubtype[]} subTypes this is for registering types that are subsets of\r\n\t\t * the current type e.g. share the same selector.\r\n\t\t * @property {number} [delay] optional delay between hovering and displaying preview.\r\n\t\t *  If not defined, delay will be zero.\r\n\t\t */\r\n\t\t/**\r\n\t\t * Register a custom preview type.\r\n\t\t *\r\n\t\t * @internal for use inside Extension:Popups only. If you want to register a preview\r\n\t\t * type, please define `attributes` key in Extension:Popups like so:\r\n\t\t * ```\r\n\t\t * \"attributes\": {\r\n\t\t *  \"Popups\": {\r\n\t\t *    \"PluginModules\": [\r\n\t\t *      \"modulename\"\r\n\t\t *    ]\r\n\t\t *  }\r\n\t\t * ```\r\n\t\t *\r\n\t\t * @unstable\r\n\t\t * @private\r\n\t\t * @param {PopupModule} module\r\n\t\t */\r\n\t\tregister: function ( module ) {\r\n\t\t\tconst { type, selector, gateway, renderFn, subTypes, delay, init,\r\n\t\t\t\tdoNotRequireSummary } = module;\r\n\t\t\tif ( !type || !selector || !gateway ) {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t`Registration of Popups custom preview type \"${ type }\" failed: You must specify a type, a selector, and a gateway.`\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tregisterModel( type, selector, delay );\r\n\t\t\tregisterGatewayForPreviewType( type, gateway );\r\n\t\t\tregisterPreviewUI( type, renderFn, doNotRequireSummary );\r\n\t\t\t// Only show if doesn't exist.\r\n\t\t\tif ( canShowSettingForPreviewType( type ) ) {\r\n\t\t\t\tregisterSetting( type, userSettings.isPreviewTypeEnabled( type ) );\r\n\t\t\t} else {\r\n\t\t\t\tmw.log.warn(\r\n\t\t\t\t\t`[Popups] No setting for ${ type } registered.\r\nPlease create message with key \"popups-settings-option-${ type }\" if this is a mistake.`\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tif ( subTypes ) {\r\n\t\t\t\tsubTypes.forEach( function ( subTypePreview ) {\r\n\t\t\t\t\tregisterPreviewUI(\r\n\t\t\t\t\t\tsubTypePreview.type,\r\n\t\t\t\t\t\tsubTypePreview.renderFn,\r\n\t\t\t\t\t\tsubTypePreview.doNotRequireSummary\r\n\t\t\t\t\t);\r\n\t\t\t\t} );\r\n\t\t\t}\r\n\t\t\t// Run initialization function if provided.\r\n\t\t\tif ( typeof init === 'function' ) {\r\n\t\t\t\tinit();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n}\r\n"],"names":["module","exports","user","isAnon","isNamed","t","e","o","n","r","id","loaded","call","m","c","p","dispatch","getState","__esModule","withExtraArgument","default","Symbol","observable","self","window","g","Math","random","toString","substring","split","join","INIT","REPLACE","PROBE_UNKNOWN_ACTION","type","i","apply","this","arguments","u","Object","defineProperty","value","enumerable","configurable","writable","a","length","Array","reduce","createStore","Error","f","s","d","l","slice","h","push","indexOf","splice","y","getPrototypeOf","subscribe","replaceReducer","TypeError","next","unsubscribe","combineReducers","keys","forEach","bindActionCreators","applyMiddleware","map","getOwnPropertySymbols","concat","filter","getOwnPropertyDescriptor","compose","__DO_NOT_USE__ActionTypes","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","getter","definition","key","get","globalThis","Function","obj","prop","prototype","hasOwnProperty","toStringTag","nmd","paths","children","bpr","dpr","devicePixelRatio","bracketedPixelRatio","FETCH_START_DELAY","FETCH_COMPLETE_TARGET_DELAY","PREVIEW_SEEN_DURATION","ABANDON_END_DELAY","BRACKETED_DEVICE_PIXEL_RATIO","THUMBNAIL_SIZE","max","EXTRACT_LENGTH","wait","delay","Promise","resolve","setTimeout","SIZES","portraitImage","w","landscapeImage","addAttributes","node","attrs","setAttribute","escapeHTML","str","mw","html","escape","templates","createNodeFromTemplate","div","document","createElement","innerHTML","firstElementChild","cloneNode","templateHTML","renderPopup","container","element","className","appendChild","renderPreview","model","message","linkMsg","popup","querySelector","classList","add","url","messageElement","remove","readLink","title","_arrayLikeToArray","arr","len","arr2","_unsupportedIterableToArray","minLen","constructor","name","from","test","defaultExtractWidth","renderPagePreview","thumbnail","withCSSClipPath","linkTitle","el","linkDiscreet","extract","languageDirection","languageCode","labelText","msg","textContent","append","isArray","iter","iterator","extractWidth","isNarrow","offset","getExtractWidth","style","width","renderers","renderersMeta","registerPreviewUI","previewFn","doNotRequireSummary","createPagePreview","requireSummary","supportsCSSClipPath","CSS","supports","rawThumbnail","useCSSClipPath","constants","thumbWidth","thumbHeight","height","tall","source","x","aspectRatio","isSquare","img","src","thumbnailWidth","thumbnailHeight","nsSvg","line","createElementNS","points","thumbnailSVGImage","setAttributeNS","xmlns","createThumbnailSVG","isTall","createThumbnail","hasThumbnail","createEmptyPreview","createDisambiguationPreview","getClosestYPosition","rects","isTop","result","minY","rect","deltaY","abs","top","bottom","floor","ceil","selectors","previewTypes","TYPE_GENERIC","TYPE_PAGE","TYPE_DISAMBIGUATION","createModel","pageId","processedExtract","processExtract","previewType","requiresSummary","getPagePreviewType","createNullModel","registeredPreviewTypes","getPreviewType","candidates","selector","matches","dwellDelay","getDwellDelay","registerModel","setDwellTime","formatPlainTextExtract","plainTextExtract","elements","boldIdentifier","snip","replace","trim","escapedTitle","util","escapeRegExp","regExp","RegExp","part","highlightNode","createTextNode","makeTitleInExtractBold","abortablePromise","promise","abort","gatewayMap","registerGatewayForPreviewType","gateway","extractPageFromResponse","data","query","pages","assign","formatter","convertPageToModel","page","canonicalurl","pagelanguagehtmlcode","pagelanguagedir","pageid","RESTBASE_PROFILE","createRESTBaseGateway","ajax","config","extractParser","fetch","endpoint","encodeURIComponent","headers","Accept","acceptLanguage","fetchPreviewForTitle","titleText","getPrefixedDb","xhr","then","catch","jqXHR","textStatus","errorThrown","reject","exception","thumbSize","Title","getUrl","lang","dir","original","parts","lastPart","originalIsSafe","filename","isSafeImgFormat","filenamePxIndex","generateThumbnailData","originalimage","parseHTMLResponse","extract_html","extractNode","childNodes","parsePlainTextResponse","options","controller","AbortController","signal","resp","json","PAGE_PREVIEWS_ENABLED_KEY","REFERENCE_PREVIEWS_ENABLED_KEY","canSaveToUserPreferences","require","initDialog","boundActions","previewTypesEnabled","dialog","choices","description","isChecked","heading","saveLabel","closeLabel","helpText","okLabel","_ref","escapeChoices","_ref2","renderSettingsDialog","createSettingsDialog","addEventListener","saveSettings","querySelectorAll","enabled","hideSettings","hideAll","nodes","display","showAll","registerChangeListener","store","callback","previousState","state","path","footerLinkElement","oldState","newState","footerListItem","href","text","footer","footerLegacy","parentNode","createFooterLink","preventDefault","showSettings","settings","shouldShowFooterLink","savedTitle","oldLink","preview","activeLink","hasAttribute","getAttribute","destroyTitleAttr","pageviewTracker","pageview","pageviews","source_page_id","source_namespace","namespaceId","source_title","newFromText","source_url","page_id","page_namespace","page_title","pageviewLogged","previewBehavior","shouldShow","createPreviewWithType","show","event","token","measures","_link","behavior","layout","isPreviewTall","pointerSpaceSize","offsetLeft","flippedX","flippedY","offsetTop","pageY","scrollTop","clientRects","pointerSize","clientTop","clientY","pageX","left","windowWidth","windowHeight","createLayout","classes","predefinedLandscapeImageHeight","marginTop","maskID","getThumbnailClipPathID","matrix","scaleX","translateX","min","getElementById","setThumbnailClipPath","layoutPreview","hasPointerOnImage","getClasses","contains","dispatchEvent","Event","previewDwell","previewAbandon","click","button","settingsUrl","stopPropagation","bindBehavior","previewShow","target","body","documentElement","hide","fadeInClass","fadeOutClass","renderer","fetchResponse","activeToken","render","settingsObj","refresh","appendTo","setEnabled","showHelp","toggleHelp","track","statsvObj","statsv","action","statsvLogged","userSettings","sync","current","storePreviewTypeEnabled","syncIfChanged","BOOT","LINK_DWELL","REGISTER_SETTING","ABANDON_START","ABANDON_END","LINK_CLICK","FETCH_START","FETCH_END","FETCH_COMPLETE","FETCH_FAILED","FETCH_ABORTED","PAGEVIEW_LOGGED","PREVIEW_DWELL","PREVIEW_SHOW","PREVIEW_CLICK","PREVIEW_SEEN","SETTINGS_SHOW","SETTINGS_HIDE","SETTINGS_CHANGE","STATSV_LOGGED","timedAction","baseAction","timestamp","now","boot","initiallyEnabled","editCount","types","isNavPopupsEnabled","pageToken","getPageviewToken","isTemp","registerSetting","namespace","chain","err","fetchType","all","_i","_s","_e","_arr","_n","_d","done","ex","showNullPreview","readyState","linkDwell","generateToken","isNewInteraction","enabledValue","abandon","_getState$preview","linkClick","currentToken","validType","oldValue","newValue","nextState","updates","hasOwn","clone","_defineProperty","actionTypes","isUserDwelling","wasClicked","nothingChanged","every","userOptedOut","some","anyDisabled","fetchStartedAt","linkDwellStartedAt","EXCLUDED_LINK_SELECTORS","handleDOMEventIfEligible","handler","nodeType","closest","findNearestEligibleTarget","mwTitle","dataset","hash","host","location","pathname","search","isOwnPageAnchorLink","decodeURIComponent","contentNamespaces","isValid","linkHref","Uri","hostname","redlink","queryLength","pattern","exec","fragment","getTitle","titleFromElement","tagName","errorLogger","logError","popupsFlags","parseInt","set","mwExperiments","storage","overlay","Redux","generateRandomSessionId","pagePreviewGateway","gatewayConfig","restConfig","api","formatversion","redirects","exintro","exchars","explaintext","exsectionformat","piprop","pithumbsize","pilicense","rvprop","inprop","titles","smaxage","maxage","uselang","createMediaWikiApiGateway","Api","formatters","enwikiAPI","restParts","restGatewayCreator","updatePreviewLink","uri","protocol","password","port","link","foundTitle","$","Deferred","limit","pageNames","pageName","createRestOpenSearchGateWay","ForeignApi","anonymous","createPagePreviewGateway","migrateOldPreferences","isPreviewTypeEnabled","storageKey","settingsDialog","previewTypesEnabledNew","parent","loader","using","requestIdleCallback","visible","formSelectors","helpSelectors","checked","experiments","weightedBoolean","trueWeight","getBucket","buckets","true","false","statsvTracker","bucketingRate","sessionId","isStatsvEnabled","getStatsvTracker","pagePreviewState","createIsPagePreviewsEnabled","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","onHover","onHoverOut","onClick","reducers","ReduxThunk","actions","createPreviewBehavior","registerActions","changeListeners","registerChangeListeners","popups","isEnabled","register","renderFn","subTypes","init","exists","canShowSettingForPreviewType","log","warn","subTypePreview","createMediaWikiPopupsObject","excludedLinksSelector","pointerMaskSVG","getGatewayForPreviewType","scrollY","bbox","getBoundingClientRect","scrollX","offsetWidth","offsetHeight","getClientRects","innerWidth","innerHeight"],"sourceRoot":""}